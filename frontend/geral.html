<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geral - Dívidas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: url('SuperEndBackgroundTransparente.png') no-repeat center center fixed;
            background-size: cover;
        }
        .container { max-width: 1600px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h1 { color: #2d5c2f; margin-bottom: 20px; }
        table { font-size: 0.88rem; }
        th, td { padding: 0.3em 0.5em !important; vertical-align: middle !important; text-align: center; }
        .table-bordered th, .table-bordered td { border: 1px solid #333 !important; }
        .total-row { font-weight: bold; background: #f0f0f0; }
        .subtotal-row { font-weight: bold; background: #e0e0e0; }
        .bg-light-black { background: #222; color: #fff; }
        .bg-light-blue { background: #eaf4ff; }
        .bg-light-orange { background: #fff3e0; }
        .bg-light-green { background: #eaffea; }
        .bg-light-cyan { background: #e0f7fa; }
        .bg-light-gray { background: #f8f9fa; }
        .text-red { color: #d00; }
        .scroll-x { overflow-x: auto; }
        .input-sm { max-width: 90px; }
        .input-xs { max-width: 60px; }
        .input-md { max-width: 120px; }
        .input-lg { max-width: 180px; }
        .form-control.input-sm, .form-control.input-md, .form-control.input-lg, .form-control.input-xs {
            min-height: 28px;
            font-size: 0.92em;
            padding: 2px 6px;
        }
        @media (max-width: 900px) {
            .row { flex-direction: column; }
            .container { padding: 10px; }
        }
        #custom-navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            background: linear-gradient(90deg, #e0ffe0 0%, #baffba 100%);
            box-shadow: 0 2px 8px #0002;
            border-radius: 0 0 16px 16px;
            padding: 6px 8px;
            margin-bottom: 18px;
            border: none;
        }
        .nav-btn {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 1em;
            padding: 10px 0;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, font-weight 0.2s;
            color: #2d5c2f;
            border-bottom: 3px solid transparent;
            border-radius: 0 0 12px 12px;
            margin: 0 4px;
        }
        .nav-btn:focus,
        .nav-btn:active,
        .nav-btn:hover,
        .nav-btn.active {
            background: #baffba;
            color: #007a00;
            font-weight: bold;
            border-bottom: 3px solid #007a00;
            outline: none;
        }
        .section-title { font-weight: bold; font-size: 1.1em; }
        .bordered { border: 2px solid #000; border-radius: 6px; padding: 10px; margin-bottom: 30px; }
        .text-end { text-align: right; }
        .text-start { text-align: left; }
        .text-center { text-align: center; }
        .small-input { width: 100px; }
        .table-title { font-weight: bold; font-size: 1.05em; background: #f5f5f5; }
        .red-link { color: #d00; font-weight: bold; text-decoration: none; }
        .table-section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <!--Barra de navegação superior-->
    <div style="width:100%;display:flex;justify-content:flex-start;margin-top:4px;margin-bottom:10px; background: #fff;gap:0;flex-wrap:wrap;position:sticky;top:0;z-index:1001;box-shadow:0 2px 8px #0002;">
        <img src="logo-superendividamento.png" alt="SUPERENDIVIDAMENTO" style="max-width:20%; min-width:5%; height:60px; display:block; box-shadow: 0 2px 8px #0001; border-radius: 12px; margin-left:4px; margin-right:0;" />
        <div style="flex:1;justify-content:flex-start; width: 80%; padding-top: 1px; padding-bottom: 1px; margin-left:4px; margin-right:4px;">
            <div id="custom-navbar" style="height: 55px; position:static;box-shadow:none;margin-bottom:2px;background:linear-gradient(90deg, #e0ffe0 0%, #baffba 100%);border-radius:16px;padding:6px 8px; margin-left:2;">
                <button onclick="window.location.href='index.html'" class="nav-btn" id="btn-dados">Dados Socioeconômicos</button>
                <button onclick="window.location.href='geral.html'" class="nav-btn" id="btn-geral">Geral</button>
                <button onclick="window.location.href='plano-de-pagamento.html'" class="nav-btn" id="btn-plano">Plano de Pagamento</button>
                <button onclick="window.location.href='panorama.html'" class="nav-btn" id="btn-panorama">Panorama</button>
            </div>
        </div>
    </div>
    <div class="container"; style="background: #ffffff00;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:30px;">
            <h1 style="color: #2d5c2f; margin-bottom: 0;">Geral - Dívidas</h1>
            <button type="button" class="btn btn-warning mb-3" style="background:#baffba; color:#2d5c2f; border:none; font-weight:bold;" onclick="limparCampos()">Limpar</button>
        </div>
        <div class="row mb-2">
            <div class="col-md-4">
                <label class="form-label">Consumidor</label>
                <input type="text" class="form-control" id="nome-consumidor" placeholder="Nome do consumidor">
            </div>
            <div class="col-md-4">
                <label class="form-label">Número do Processo</label>
                <input type="text" class="form-control" id="numero-processo" placeholder="Número do processo" oninput="localStorage.setItem('numero-processo', this.value)">
            </div>
            <div class="col-md-4 text-end">
                <a href="https://www.cnj.jus.br/wp-content/uploads/2022/08/cartilha-superendividamento.pdf" target="_blank" class="red-link">Cartilha Superendividamento CNJ</a>
            </div>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0" id="tabela-consignados">
                <thead>
                    <tr class="table-title bg-light-black">
                        <h2 style="color: #000000; margin-bottom: 0; text-align: center; padding-bottom: 10px; padding-top: 20px;">Dívidas</h2>
                    </tr>
                    <tr class="table-title bg-light-black">
                        <td colspan="10">CONSIGNADOS</td>
                    </tr>
                    <tr class="bg-light-gray">
                        <th>Credores</th>
                        <th>Contrato</th>
                        <th>Valor contratado</th>
                        <th>Valor pago</th>
                        <th>Saldo devedor</th>
                        <th>Juros</th>
                        <th>Parcela Mensal</th>
                        <th>Parcelas contratadas</th>
                        <th>Parcelas restantes</th>
                    </tr>
                </thead>
                <tbody id="tbody-consignados">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row" id="total-row-consignados">
                        <td colspan="2">Total</td>
                        <td id="total-valor-contratado"></td>
                        <td id="total-valor-pago"></td>
                        <td id="total-saldo-devedor"></td>
                        <td id="total-juros"></td>
                        <td id="total-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0">
                <tr class="table-title bg-light-blue">
                    <td colspan="10">NÃO CONSIGNADOS</td>
                </tr>
                <tr class="bg-light-gray">
                    <th>Credores</th>
                    <th>Contratos</th>
                    <th>Valor contratado</th>
                    <th>Valor pago</th>
                    <th>Saldo devedor</th>
                    <th>Juros</th>
                    <th>Parcela Mensal</th>
                    <th>Parcelas contratadas</th>
                    <th>Parcelas restantes</th>
                </tr>
                <tbody id="tbody-nao-consignados">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Total</td>
                        <td id="total-nao-consignados-valor-contratado"></td>
                        <td id="total-nao-consignados-valor-pago"></td>
                        <td id="total-nao-consignados-saldo-devedor"></td>
                        <td></td>
                        <td id="total-nao-consignados-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0">
                <tr class="table-title bg-light-orange">
                    <td colspan="10">SEM PARCELAS</td>
                </tr>
                <tr class="bg-light-gray">
                    <th>Credores</th>
                    <th>Contratos</th>
                    <th>Valor contratado</th>
                    <th>Valor pago</th>
                    <th>Saldo devedor</th>
                    <th>Juros</th>
                    <th>Parcela Mensal</th>
                    <th>Parcelas contratadas</th>
                    <th>Parcelas restantes</th>
                </tr>
                <tbody id="tbody-sem-parcelas">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Total</td>
                        <td id="total-sem-parcelas-valor-contratado"></td>
                        <td id="total-sem-parcelas-valor-pago"></td>
                        <td id="total-sem-parcelas-saldo-devedor"></td>
                        <td></td>
                        <td id="total-sem-parcelas-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0">
                <tr class="table-title bg-light-green">
                    <td colspan="10">DÍVIDAS CONSOLIDADAS</td>
                </tr>
                <tr class="bg-light-gray">
                    <th>Credores</th>
                    <th>Contratos</th>
                    <th>Valor contratado</th>
                    <th>Valor pago</th>
                    <th>Saldo devedor</th>
                    <th>Juros</th>
                    <th>Parcela Mensal</th>
                    <th>Parcelas contratadas</th>
                    <th>Parcelas restantes</th>
                </tr>
                <tbody id="tbody-dividas-consolidadas">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Total</td>
                        <td id="total-dividas-consolidadas-valor-contratado"></td>
                        <td id="total-dividas-consolidadas-valor-pago"></td>
                        <td id="total-dividas-consolidadas-saldo-devedor"></td>
                        <td></td>
                        <td id="total-dividas-consolidadas-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="row mt-4 table-section">
            <div class="col-12 scroll-x">
                <table class="table table-bordered mb-0" id="tabela-rendimentos">
                    <thead>
                        <tr class="table-title bg-light-cyan">
                            <td colspan="5">RENDIMENTOS</td>
                        </tr>
                        <tr class="bg-light-gray">
                            <th>Fonte Pagadora</th>
                            <th>Valor Líquido</th>
                            <th>Informação</th>
                            <th>Data do Dado</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-rendimentos">
                        <!-- Linhas geradas dinamicamente -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Total</td>
                            <td><input class="form-control" type="text" id="rendimento-total-valor-liquido" readonly></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const bancos = [
        '', 'Itaú', 'Bradesco', 'BMG RMG', 'Agibank', 'Banco do Brasil', 'Santander', 'Mercantil do Brasil', 'Sicob'
    ];

    document.addEventListener('DOMContentLoaded', function() {
        renderTabelaConsignados();
        renderTabelaNaoConsignados();
        renderTabelaSemParcelas();
        renderTabelaDividasConsolidadas();
    });

    window.onload = function() {
        // Restaurar valores dos campos de input e select
        document.querySelectorAll('input, select').forEach(function(el) {
            if (el.id && localStorage.getItem(el.id)) {
                el.value = localStorage.getItem(el.id);
            }
            // Adicionar listeners para salvar alterações
            el.addEventListener('change', function() {
                if (this.id) localStorage.setItem(this.id, this.value);
            });
            el.addEventListener('input', function() {
                if (this.id) localStorage.setItem(this.id, this.value);
            });
        });

        // Preencher automaticamente a tabela de RENDIMENTOS com dados das receitas do index.html (dinâmico)
        const receitasMap = [
            { fonte: 'Salários ganhos/líquidos', id: 'receita-salarios' },
            { fonte: 'Ganho mínimo como autônomo', id: 'receita-ganho-minimo' },
            { fonte: 'Aposentadoria', id: 'receita-aposentadoria' },
            { fonte: 'Pensão Previdenciária (pensão por morte)', id: 'receita-pensao-previdenciaria' },
            { fonte: 'Aluguel', id: 'receita-aluguel' },
            { fonte: 'Pensão Alimentícia (se descontada em folha de pagamento)', id: 'receita-pensao-alimenticia' },
            { fonte: 'Renda temporária', id: 'receita-renda-temporaria' },
            { fonte: 'Auxílio por incapacidade', id: 'receita-auxilio-por-incapacidade' },
            { fonte: 'Auxilio acidente', id: 'receita-auxilio-acidente' },
            { fonte: 'Auxílio reclusão', id: 'receita-auxilio-reclusao' },
            { fonte: 'Salário Maternidade', id: 'receita-salario-maternidade' },
            { fonte: 'Participações nos lucros ou comissões', id: 'receita-participacoes-nos-lucros-ou-comissoes' },
            { fonte: '13º salário', id: 'receita-13-salario' },
            { fonte: 'Outros', id: 'receita-outros' }
        ];
        let totalRendimentos = 0;
        let linhasRendimentos = '';
        receitasMap.forEach(item => {
            const valor = localStorage.getItem(item.id);
            const evento = localStorage.getItem(item.id + '-evento') || '';
            const dataEvento = localStorage.getItem(item.id + '-evento-data') || '';
            if (valor && !isNaN(parseFloat(valor)) && parseFloat(valor) > 0) {
                linhasRendimentos += `<tr>` +
                    `<td><input class='form-control' type='text' value='${item.fonte}' readonly></td>` +
                    `<td><input class='form-control' type='text' value='${valor}' readonly></td>` +
                    `<td><input class='form-control' type='text' value='${evento}' readonly></td>` +
                    `<td><input class='form-control' type='text' value='${dataEvento}' readonly></td>` +
                `</tr>`;
                totalRendimentos += parseFloat(valor);
            }
        });
        document.getElementById('tbody-rendimentos').innerHTML = linhasRendimentos;
        document.getElementById('rendimento-total-valor-liquido').value = totalRendimentos > 0 ? totalRendimentos.toFixed(2) : '';

        // Ativa o botão da página atual
        const page = window.location.pathname.split('/').pop();
        if(page.includes('dados-socioeconomicos')) document.getElementById('btn-dados').classList.add('active');
        if(page.includes('geral')) document.getElementById('btn-geral').classList.add('active');
        if(page.includes('plano-de-pagamento')) document.getElementById('btn-plano').classList.add('active');
        if(page.includes('panorama')) document.getElementById('btn-panorama').classList.add('active');

        // Inicializar tabela de consignados
        renderTabelaConsignados();
        
        // Inicializar cálculos automáticos
        const linhas = [
            'nao-consignado-1', 'nao-consignado-2',
            'sem-parcela-1',
            'divida-consolidada-1', 'divida-consolidada-2'
        ];
        linhas.forEach(function(prefix) {
            const contratado = document.getElementById(prefix+'-valor-contratado');
            const pago = document.getElementById(prefix+'-valor-pago');
            if (contratado && pago) {
                contratado.addEventListener('input', function() { atualizarSaldoDevedor(prefix); });
                pago.addEventListener('input', function() { atualizarSaldoDevedor(prefix); });
                // Inicializa ao carregar
                atualizarSaldoDevedor(prefix);
            }
        });
    };

    function limparCampos() {
        if (!confirm('Tem certeza que deseja limpar todos os dados?')) {
            return;
        }
        // Limpar todos os campos do formulário
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(function(input) {
            input.value = '';
            if (input.id) localStorage.removeItem(input.id);
        });
        // Limpar todos os selects (dropdowns)
        document.querySelectorAll('select').forEach(function(select) {
            select.value = '';
            if (select.id) localStorage.removeItem(select.id);
        });
        // Limpar linhas dinâmicas de consignados
        localStorage.removeItem('linhas-consignados');
        localStorage.removeItem('linhas-nao-consignados');
        localStorage.removeItem('linhas-sem-parcelas');
        localStorage.removeItem('linhas-dividas-consolidadas');
        // Limpar apenas os campos de input relacionados à geral.html
        const geralKeys = [
            'nome-consumidor',
            'numero-processo',
            // Adicione aqui outros IDs de campos exclusivos da geral.html, se houver
        ];
        geralKeys.forEach(key => localStorage.removeItem(key));
        // Renderizar as tabelas vazias
        renderTabelaConsignados();
        renderTabelaNaoConsignados();
        renderTabelaSemParcelas();
        renderTabelaDividasConsolidadas();
        // Atualizar totais
        atualizarTotaisConsignados();
        atualizarTotaisNaoConsignados();
        atualizarTotaisSemParcelas();
        atualizarTotaisDividasConsolidadas();
        // Limpar rendimentos da tabela
        document.getElementById('tbody-rendimentos').innerHTML = '';
        document.getElementById('rendimento-total-valor-liquido').value = '';
    }

    function atualizarSaldoDevedor(prefix) {
        const valorContratado = parseFloat(document.getElementById(prefix+'-valor-contratado').value);
        const valorPago = parseFloat(document.getElementById(prefix+'-valor-pago').value);
        let saldo = '';
        if (!isNaN(valorContratado) && !isNaN(valorPago)) {
            saldo = (valorContratado - valorPago).toFixed(2);
        }
        document.getElementById(prefix+'-saldo-devedor').value = saldo;
        localStorage.setItem(prefix+'-saldo-devedor', saldo);
    }

    function atualizarTotaisConsignados() {
        let linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(calcularSaldoDevedor(linha)) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        document.getElementById('total-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        document.getElementById('total-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        document.getElementById('total-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        document.getElementById('total-juros').textContent = '';
        document.getElementById('total-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function calcularSaldoDevedor(dados) {
        const contratado = parseFloat(dados.valorContratado) || 0;
        const pago = parseFloat(dados.valorPago) || 0;
        return contratado || pago ? (contratado - pago).toFixed(2) : '';
    }

    function formatarJuros(valor) {
        if (!valor) return '';
        valor = valor.toString().replace('%','').replace(',','.');
        if (valor === '') return '';
        if (isNaN(valor)) return '';
        return parseFloat(valor) + '%';
    }

    function atualizarListenersConsignados() {
        const tbody = document.getElementById('tbody-consignados');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            
            // Listener para dropdown do credor
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        // Se selecionar 'Selecione', remove a linha
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
                        renderTabelaConsignados();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
                    renderTabelaConsignados();
                });
            }
            
            // Listeners para inputs
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    
                    // Mapear o índice do input para o campo correto
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        
                        // Se for valor contratado ou valor pago, recalcular saldo devedor
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            
                            // Atualizar o campo de saldo devedor na interface
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        
                        localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
                        atualizarTotaisConsignados();
                    }
                });
            });
        });
    }

    function renderTabelaConsignados() {
        const tbody = document.getElementById('tbody-consignados');
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
        
        // Remove linhas totalmente vazias exceto a última
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        
        // Garante sempre uma linha vazia ao final
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        
        // Renderiza cada linha
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaConsignado(linha);
        });
        
        // Salva o estado atual das linhas
        localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
        
        // Atualiza os listeners e totais
        atualizarListenersConsignados();
        atualizarTotaisConsignados();
    }

    function criarLinhaConsignado(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // --- NÃO CONSIGNADOS ---
    function atualizarListenersNaoConsignados() {
        const tbody = document.getElementById('tbody-nao-consignados');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
                        renderTabelaNaoConsignados();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
                    renderTabelaNaoConsignados();
                });
            }
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
                        atualizarTotaisNaoConsignados();
                    }
                });
            });
        });
    }

    function atualizarTotaisNaoConsignados() {
        let linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        // Exibir os totais no rodapé da tabela NAO CONSIGNADOS
        if(document.getElementById('total-nao-consignados-valor-contratado'))
            document.getElementById('total-nao-consignados-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        if(document.getElementById('total-nao-consignados-valor-pago'))
            document.getElementById('total-nao-consignados-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        if(document.getElementById('total-nao-consignados-saldo-devedor'))
            document.getElementById('total-nao-consignados-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        if(document.getElementById('total-nao-consignados-parcela-mensal'))
            document.getElementById('total-nao-consignados-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function renderTabelaNaoConsignados() {
        const tbody = document.getElementById('tbody-nao-consignados');
        if (!tbody) return;
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
        // Remove linhas totalmente vazias exceto a última
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        // Garante sempre uma linha vazia ao final
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaNaoConsignado(linha);
        });
        localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
        atualizarListenersNaoConsignados();
        atualizarTotaisNaoConsignados();
    }

    function criarLinhaNaoConsignado(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // --- SEM PARCELAS ---
    function atualizarListenersSemParcelas() {
        const tbody = document.getElementById('tbody-sem-parcelas');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
                        renderTabelaSemParcelas();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
                    renderTabelaSemParcelas();
                });
            }
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
                        atualizarTotaisSemParcelas();
                    }
                });
            });
        });
    }

    function atualizarTotaisSemParcelas() {
        let linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        if(document.getElementById('total-sem-parcelas-valor-contratado'))
            document.getElementById('total-sem-parcelas-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        if(document.getElementById('total-sem-parcelas-valor-pago'))
            document.getElementById('total-sem-parcelas-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        if(document.getElementById('total-sem-parcelas-saldo-devedor'))
            document.getElementById('total-sem-parcelas-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        if(document.getElementById('total-sem-parcelas-parcela-mensal'))
            document.getElementById('total-sem-parcelas-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function renderTabelaSemParcelas() {
        const tbody = document.getElementById('tbody-sem-parcelas');
        if (!tbody) return;
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaSemParcela(linha);
        });
        localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
        atualizarListenersSemParcelas();
        atualizarTotaisSemParcelas();
    }

    function criarLinhaSemParcela(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // --- DÍVIDAS CONSOLIDADAS ---
    function atualizarListenersDividasConsolidadas() {
        const tbody = document.getElementById('tbody-dividas-consolidadas');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
                        renderTabelaDividasConsolidadas();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
                    renderTabelaDividasConsolidadas();
                });
            }
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
                        atualizarTotaisDividasConsolidadas();
                    }
                });
            });
        });
    }

    function atualizarTotaisDividasConsolidadas() {
        let linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        if(document.getElementById('total-dividas-consolidadas-valor-contratado'))
            document.getElementById('total-dividas-consolidadas-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        if(document.getElementById('total-dividas-consolidadas-valor-pago'))
            document.getElementById('total-dividas-consolidadas-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        if(document.getElementById('total-dividas-consolidadas-saldo-devedor'))
            document.getElementById('total-dividas-consolidadas-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        if(document.getElementById('total-dividas-consolidadas-parcela-mensal'))
            document.getElementById('total-dividas-consolidadas-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function renderTabelaDividasConsolidadas() {
        const tbody = document.getElementById('tbody-dividas-consolidadas');
        if (!tbody) return;
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaDividaConsolidada(linha);
        });
        localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
        atualizarListenersDividasConsolidadas();
        atualizarTotaisDividasConsolidadas();
    }

    function criarLinhaDividaConsolidada(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }
    </script>
</body>
</html> 