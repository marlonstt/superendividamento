<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geral - D√≠vidas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: url('SuperEndBackgroundTransparente.png') no-repeat center center fixed;
            background-size: cover;
        }
        .container { max-width: 1200px; margin: 30px auto; background: #ffffff00; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 248, 74, 0.263); }
        h1 { color: #2d5c2f; margin-bottom: 20px; }
        table { font-size: 0.88rem; }
        th, td { padding: 0.3em 0.5em !important; vertical-align: middle !important; text-align: center; }
        .table-bordered th, .table-bordered td { border: 1px solid #333 !important; }
        .total-row { font-weight: bold; background: #f0f0f0; }
        .total-row.dark-theme { background: #23272b !important; color: #fff !important; }
        .subtotal-row { font-weight: bold; background: #e0e0e0; }
        .bg-light-black { background: #222; color: #fff; }
        .bg-light-blue { background: #eaf4ff; }
        .bg-light-orange { background: #fff3e0; }
        .bg-light-green { background: #eaffea; }
        .bg-light-cyan { background: #e0f7fa; }
        .bg-light-gray { background: #f8f9fa; }
        .text-red { color: #d00; }
        .scroll-x { overflow-x: auto; }
        .input-sm { max-width: 90px; }
        .input-xs { max-width: 60px; }
        .input-md { max-width: 120px; }
        .input-lg { max-width: 180px; }
        .form-control.input-sm, .form-control.input-md, .form-control.input-lg, .form-control.input-xs {
            min-height: 28px;
            font-size: 0.92em;
            padding: 2px 6px;
        }
        @media (max-width: 900px) {
            .row { flex-direction: column; }
            .container { padding: 10px; }
        }
        #custom-navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            background: linear-gradient(90deg, #e0ffe0 0%, #baffba 100%);
            box-shadow: 0 2px 8px #0002;
            border-radius: 0 0 16px 16px;
            padding: 6px 8px;
            margin-bottom: 18px;
            border: none;
        }
        .nav-btn {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 1em;
            padding: 10px 0;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, font-weight 0.2s;
            color: #2d5c2f;
            border-bottom: 3px solid transparent;
            border-radius: 0 0 12px 12px;
            margin: 0 4px;
        }
        .nav-btn:focus,
        .nav-btn:active,
        .nav-btn:hover,
        .nav-btn.active {
            background: #baffba;
            color: #007a00;
            font-weight: bold;
            border-bottom: 3px solid #007a00;
            outline: none;
        }
        .section-title { font-weight: bold; font-size: 1.1em; }
        .bordered { border: 2px solid #000; border-radius: 6px; padding: 10px; margin-bottom: 30px; }
        .text-end { text-align: right; }
        .text-start { text-align: left; }
        .text-center { text-align: center; }
        .small-input { width: 100px; }
        .table-title { font-weight: bold; font-size: 1.05em; background: #f5f5f5; }
        .red-link { color: #d00; font-weight: bold; text-decoration: none; }
        .table-section { margin-bottom: 30px; }
        #custom-navbar.dark-theme {
            background: rgba(35,39,43,0.95) !important;
            box-shadow: 0 2px 8px #0008;
        }
        .nav-btn.dark-theme { color: #baffba !important; background: transparent !important; }
        .nav-btn.dark-theme.active, .nav-btn.dark-theme:focus, .nav-btn.dark-theme:active, .nav-btn.dark-theme:hover { background: #2e3b2e !important; color: #baffba !important; border-bottom: 3px solid #baffba !important; }
        table.dark-theme {
            background: rgba(35,39,43,0.65) !important;
        }
        thead.dark-theme, tfoot.dark-theme, .table-title.dark-theme {
            background: transparent !important;
            color: #e0e0e0 !important;
        }
        th.dark-theme, td.dark-theme {
            background: rgba(35,39,43,0.15) !important;
            color: #e0e0e0 !important;
        }
        input.dark-theme, select.dark-theme, textarea.dark-theme {
            background: rgba(35,39,43,0.15) !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        input.dark-theme::placeholder, select.dark-theme::placeholder, textarea.dark-theme::placeholder {
            color: #bbb !important;
        }
        #tabela-rendimentos input.dark-theme, #tabela-rendimentos select.dark-theme, #tabela-rendimentos textarea.dark-theme {
            background: rgba(35,39,43,0.15) !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        .btn, .btn-success, .btn-warning, .btn-primary, .btn-danger, .btn-info {
            transition: background 0.2s, color 0.2s;
        }
        .btn.dark-theme, .btn-success.dark-theme, .btn-warning.dark-theme, .btn-primary.dark-theme, .btn-danger.dark-theme, .btn-info.dark-theme {
            background: #333 !important;
            color: #fff !important;
            border: 1px solid #555 !important;
        }
        .btn.dark-theme:hover, .btn-success.dark-theme:hover, .btn-warning.dark-theme:hover, .btn-primary.dark-theme:hover, .btn-danger.dark-theme:hover, .btn-info.dark-theme:hover {
            background: #444 !important;
            color: #baffba !important;
        }
        .form-switch .form-check-input.dark-theme {
            background-color: #23272b !important;
            border-color: #baffba !important;
        }
        .form-switch .form-check-input.dark-theme:checked {
            background-color: #baffba !important;
            border-color: #baffba !important;
        }
        .bg-light-black.dark-theme, .bg-light-blue.dark-theme, .bg-light-orange.dark-theme, .bg-light-green.dark-theme, .bg-light-cyan.dark-theme, .bg-light-gray.dark-theme, .bg-medium-gray.dark-theme {
            background: #23272b !important;
            color: #fff !important;
        }
        .red-link.dark-theme { color: #ff7b7b !important; }
        .section-title.dark-theme, .table-title.dark-theme { color: #fff !important; }
        body.dark-theme {
            background: url('SuperEndBackgroundTransparente-Dark.png') no-repeat center center fixed !important;
            background-size: cover !important;
            color: #fff !important;
        }
        html.dark-theme { background: #181a1b !important; }
        html.dark-theme .container, body.dark-theme .container { background: rgba(35,39,43,0.32) !important; color: #fff !important; box-shadow: 0 2px 8px #0008; }
        html.dark-theme #btn-theme-toggle, body.dark-theme #btn-theme-toggle { background: rgba(35,39,43,0.32) !important; color: #fff !important; }
        html.dark-theme table, body.dark-theme table { background: rgba(35,39,43,0.32) !important; }
        html.dark-theme th, body.dark-theme th, html.dark-theme td, body.dark-theme td { background: rgba(35,39,43,0.12) !important; color: #fff !important; }
        h1.dark-theme, h2.dark-theme, h3.dark-theme, h4.dark-theme, h5.dark-theme, h6.dark-theme {
            color: #fff !important;
            background: transparent !important;
        }
        .limpar-btn, .imprimir-btn {
            border: 1.5px solid #baffba !important;
            color: #2d5c2f !important;
            background: #baffba !important;
            font-weight: bold;
            transition: border 0.2s;
        }
        .dark-theme .limpar-btn, .dark-theme .imprimir-btn {
            border: 1.5px solid #baffba !important;
            color: #baffba !important;
            background: transparent !important;
        }
        .container.dark-theme, .row.dark-theme, [class^="col-"] .dark-theme, h1.dark-theme, h2.dark-theme, h3.dark-theme, h4.dark-theme, h5.dark-theme, h6.dark-theme, .section-title.dark-theme, .bordered.dark-theme, .table-section.dark-theme {
            background: transparent !important;
        }
        .bg-light-black.dark-theme, .bg-light-blue.dark-theme, .bg-light-orange.dark-theme, .bg-light-green.dark-theme, .bg-light-cyan.dark-theme, .bg-light-gray.dark-theme, .table-title.dark-theme, .subtotal-row.dark-theme, .total-row.dark-theme {
            background: transparent !important;
        }
        .table input.dark-theme, .table select.dark-theme, .table textarea.dark-theme {
            background: rgba(35,39,43,0.15) !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        #tabela-rendimentos.dark-theme {
            background: rgba(35,39,43,0.15) !important;
        }
        select.dark-theme {
            background: #23272b !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        select.dark-theme:focus {
            background: #23272b !important;
            color: #fff !important;
            border: 1.5px solid #baffba !important;
        }
        select.dark-theme option {
            background: #23272b !important;
            color: #fff !important;
        }
        /* === CSS DARK MODE E TABELAS (copiado da index.html) === */
        table.dark-theme tr {
            background: transparent !important;
        }
        table.dark-theme th, table.dark-theme td {
            background: rgba(35,39,43,0.15) !important;
            color: #fff !important;
        }
        table.dark-theme {
            background: rgba(35,39,43,0.65) !important;
        }
        table.dark-theme thead, table.dark-theme tfoot {
            background: transparent !important;
            color: #fff !important;
        }
        table.dark-theme .total-row.dark-theme td,
        table.dark-theme .total-row.dark-theme {
            background: #23272b !important;
            color: #fff !important;
        }
        table.table.table-bordered.dark-theme,
        table.table.dark-theme,
        table.dark-theme {
            background: rgba(35,39,43,0.65) !important;
        }
        table.table.table-bordered.dark-theme th,
        table.table.table-bordered.dark-theme td,
        table.table.dark-theme th,
        table.table.dark-theme td,
        table.dark-theme th,
        table.dark-theme td {
            background: rgba(35,39,43,0.15) !important;
            color: #fff !important;
        }
        table.table.table-bordered.dark-theme tr,
        table.table.dark-theme tr,
        table.dark-theme tr {
            background: transparent !important;
        }
        table.table.table-bordered.dark-theme thead,
        table.table.table-bordered.dark-theme tfoot,
        table.table.dark-theme thead,
        table.table.dark-theme tfoot,
        table.dark-theme thead,
        table.dark-theme tfoot {
            background: #23272b !important;
            color: #fff !important;
        }
        table.table.table-bordered.dark-theme .total-row,
        table.table.table-bordered.dark-theme .total-row td,
        table.table.dark-theme .total-row,
        table.table.dark-theme .total-row td,
        table.dark-theme .total-row,
        table.dark-theme .total-row td {
            background: #23272b !important;
            color: #fff !important;
        }
        @media print {
            #custom-navbar,
            .navbar,
            #theme-toggle,
            #btn-theme-toggle,
            #btn-imprimir,
            #limpar-btn,
            .limpar-btn,
            #logo-superend,
            body > div[style*="position:sticky"],
            #btn-theme-toggle {
                display: none !important;
            }
            .container {
                background: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
            }
        }
        html.dark-theme input#nome-consumidor,
        body.dark-theme input#nome-consumidor,
        html.dark-theme input#numero-processo,
        body.dark-theme input#numero-processo {
            background: rgba(35,39,43,0.32) !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        .conteudo-escondido { visibility: hidden; }
        #page-load-overlay {
          position: fixed;
          top: 0; left: 0; width: 100vw; height: 100vh;
          background: #fff;
          z-index: 99999;
          transition: opacity 0.3s;
        }
        html.dark-theme #page-load-overlay, body.dark-theme #page-load-overlay {
          background: #181a1b;
        }
        #page-load-overlay.hide {
          opacity: 0;
          pointer-events: none;
        }
        #page-transition-overlay {
          position: fixed;
          top: 0; left: 0; width: 100vw; height: 100vh;
          background: url('SuperEndBackgroundTransparente.png') no-repeat center center fixed;
          background-size: cover;
          z-index: 99999;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.07s;
        }
        html.dark-theme #page-transition-overlay, body.dark-theme #page-transition-overlay {
          background: url('SuperEndBackgroundTransparente-Dark.png') no-repeat center center fixed;
          background-size: cover;
        }
        #page-transition-overlay.active {
          opacity: 1;
          pointer-events: all;
        }
        /* Estilos espec√≠ficos para corre√ß√£o monet√°ria no tema escuro */
        body.dark-theme .form-label[for="indice-correcao"],
        body.dark-theme .form-label[for="data-base-correcao"],
        body.dark-theme .form-label[for="data-atual-correcao"] {
            color: white !important;
        }
        
        body.dark-theme .alert.alert-info {
            background: transparent !important;
            color: #90EE90 !important;
        }
        
        body.dark-theme .alert.alert-info strong,
        body.dark-theme .alert.alert-info span {
            color: #90EE90 !important;
        }
        
        /* Reduzir transpar√™ncia do card de corre√ß√£o monet√°ria apenas no tema escuro */
        .card.dark-theme {
            background-color: rgba(33, 37, 41, 0.95) !important;
            backdrop-filter: blur(10px);
        }
        
        /* Garantir fundo claro no tema claro */
        .card:not(.dark-theme) {
            background: #fff !important;
            color: #222 !important;
            opacity: 1 !important;
            box-shadow: 0 2px 8px #0001;
            position: relative;
            z-index: 1;
        }
        body:not(.dark-theme) .container {
            background: none !important;
        }
        /* Ajuste para a se√ß√£o de Corre√ß√£o Monet√°ria no tema escuro */
        body.dark-theme .card,
        body.dark-theme .card-header,
        body.dark-theme .card-body {
            background-color: rgba(33, 37, 41, 0.95) !important;
            color: #fff !important;
            box-shadow: 0 2px 8px #0008;
        }
        body.dark-theme .card-header {
            border-bottom: 1px solid #444 !important;
        }
        body.dark-theme .card-body {
            border-radius: 0 0 8px 8px;
        }
        .card:not(.dark-theme) {
            background: #fff !important;
            color: #222 !important;
            opacity: 1 !important;
            box-shadow: 0 2px 8px #0001;
            position: relative;
            z-index: 1;
        }
    </style>
    <script>
      try {
        if (localStorage.getItem('theme') === 'dark') {
          document.documentElement.classList.add('dark-theme');
          document.body.classList.add('dark-theme');
        }
      } catch(e){}

      // Garante que, se n√£o houver tema salvo, o padr√£o ser√° claro e a imagem padr√£o ser√° usada
      if (!localStorage.getItem('theme')) {
        localStorage.setItem('theme', 'light');
        document.body.style.backgroundImage = "url('SuperEndBackgroundTransparente.png')";
      }
    </script>
</head>
<body>
    <!--Barra de navega√ß√£o superior-->
    <div style="width:100%;display:flex;justify-content:flex-start;margin-top:4px;margin-bottom:10px;gap:0;flex-wrap:wrap;position:sticky;top:0;z-index:1001;box-shadow:0 2px 8px #0002;">
        <img id="logo-superend" src="logo-superendividamento.png" alt="SUPERENDIVIDAMENTO" style="max-width:20%; min-width:5%; height:60px; display:block; box-shadow: 0 2px 8px #0001; border-radius: 12px; margin-left:4px; margin-right:0;" />
        <div style="flex:1;justify-content:flex-start; width: 80%; padding-top: 1px; padding-bottom: 1px; margin-left:4px; margin-right:50px;">
            <div id="custom-navbar" style="height: 55px; position:static;box-shadow:none;margin-bottom:2px;border-radius:16px;padding:6px 8px; margin-left:2;">
                <button onclick="navegarComTema('index.html')" class="nav-btn" id="btn-dados">Dados Socioecon√¥micos</button>
                <button onclick="navegarComTema('geral.html')" class="nav-btn" id="btn-geral">Geral</button>
                <button onclick="navegarComTema('plano-de-pagamento.html')" class="nav-btn" id="btn-plano">Plano de Pagamento</button>
                <button onclick="navegarComTema('panorama.html')" class="nav-btn" id="btn-panorama">Panorama</button>
            </div>
        </div>
    </div>
    <div id="page-load-overlay"></div>
    <div class="container conteudo-escondido">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:30px; gap:16px;">
            <h1 style="margin:0;">Geral - D√≠vidas</h1>
            <div style="display:flex; gap:10px; align-items:center;">
                <button type="button" class="imprimir-btn btn btn-success mb-3" id="btn-imprimir" onclick="window.print()">Imprimir</button>
                <button type="button" class="limpar-btn btn btn-warning mb-3" id="limpar-btn" onclick="limparCampos()">Limpar</button>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-4">
                <label class="form-label">Consumidor</label>
                <input type="text" class="form-control" id="nome-consumidor" placeholder="Nome do consumidor">
            </div>
            <div class="col-md-4">
                <label class="form-label">N√∫mero do Processo</label>
                <input type="text" class="form-control" id="numero-processo" placeholder="N√∫mero do processo" oninput="localStorage.setItem('numero-processo', this.value)">
            </div>
            <div class="col-md-4 text-end">
                <a href="https://www.cnj.jus.br/wp-content/uploads/2022/08/cartilha-superendividamento.pdf" target="_blank" class="red-link">Cartilha Superendividamento CNJ</a>
            </div>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0" id="tabela-consignados">
                <thead>
                    <tr class="table-title bg-light-black">
                        <h2 style="color: #2d5c2f; margin-bottom: 0; text-align: center; padding-bottom: 10px; padding-top: 20px;">D√≠vidas</h2>
                    </tr>
                    <tr class="table-title bg-light-black">
                        <td colspan="11">CONSIGNADOS</td>
                    </tr>
                    <tr class="bg-light-gray">
                        <th>Credores</th>
                        <th>Contrato</th>
                        <th>Valor contratado</th>
                        <th>Valor pago</th>
                        <th>Saldo devedor</th>
                        <th>Valor Corrigido</th>
                        <th>Data Contrata√ß√£o</th>
                        <th>Juros</th>
                        <th>Parcela Mensal</th>
                        <th>Parcelas contratadas</th>
                        <th>Parcelas restantes</th>
                    </tr>
                </thead>
                <tbody id="tbody-consignados">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row" id="total-row-consignados">
                        <td colspan="2">Total</td>
                        <td id="total-valor-contratado"></td>
                        <td id="total-valor-pago"></td>
                        <td id="total-saldo-devedor"></td>
                        <td></td>
                        <td></td>
                        <td id="total-juros"></td>
                        <td id="total-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0">
                <tr class="table-title bg-light-blue">
                    <td colspan="11">N√ÉO CONSIGNADOS</td>
                </tr>
                <tr class="bg-light-gray">
                    <th>Credores</th>
                    <th>Contratos</th>
                    <th>Valor contratado</th>
                    <th>Valor pago</th>
                    <th>Saldo devedor</th>
                    <th>Valor Corrigido</th>
                    <th>Data Contrata√ß√£o</th>
                    <th>Juros</th>
                    <th>Parcela Mensal</th>
                    <th>Parcelas contratadas</th>
                    <th>Parcelas restantes</th>
                </tr>
                <tbody id="tbody-nao-consignados">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Total</td>
                        <td id="total-nao-consignados-valor-contratado"></td>
                        <td id="total-nao-consignados-valor-pago"></td>
                        <td id="total-nao-consignados-saldo-devedor"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td id="total-nao-consignados-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0">
                <tr class="table-title bg-light-orange">
                    <td colspan="11">SEM PARCELAS</td>
                </tr>
                <tr class="bg-light-gray">
                    <th>Credores</th>
                    <th>Contratos</th>
                    <th>Valor contratado</th>
                    <th>Valor pago</th>
                    <th>Saldo devedor</th>
                    <th>Valor Corrigido</th>
                    <th>Data Contrata√ß√£o</th>
                    <th>Juros</th>
                    <th>Parcela Mensal</th>
                    <th>Parcelas contratadas</th>
                    <th>Parcelas restantes</th>
                </tr>
                <tbody id="tbody-sem-parcelas">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Total</td>
                        <td id="total-sem-parcelas-valor-contratado"></td>
                        <td id="total-sem-parcelas-valor-pago"></td>
                        <td id="total-sem-parcelas-saldo-devedor"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td id="total-sem-parcelas-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="scroll-x table-section">
            <table class="table table-bordered mb-0">
                <tr class="table-title bg-light-green">
                    <td colspan="11">D√çVIDAS CONSOLIDADAS</td>
                </tr>
                <tr class="bg-light-gray">
                    <th>Credores</th>
                    <th>Contratos</th>
                    <th>Valor contratado</th>
                    <th>Valor pago</th>
                    <th>Saldo devedor</th>
                    <th>Valor Corrigido</th>
                    <th>Data Contrata√ß√£o</th>
                    <th>Juros</th>
                    <th>Parcela Mensal</th>
                    <th>Parcelas contratadas</th>
                    <th>Parcelas restantes</th>
                </tr>
                <tbody id="tbody-dividas-consolidadas">
                    <!-- Linhas geradas dinamicamente -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Total</td>
                        <td id="total-dividas-consolidadas-valor-contratado"></td>
                        <td id="total-dividas-consolidadas-valor-pago"></td>
                        <td id="total-dividas-consolidadas-saldo-devedor"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td id="total-dividas-consolidadas-parcela-mensal"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="row mt-4 table-section">
            <div class="col-12 scroll-x">
                <table class="table table-bordered mb-0" id="tabela-rendimentos">
                    <thead>
                        <tr class="table-title bg-light-cyan">
                            <td colspan="5">RENDIMENTOS</td>
                        </tr>
                        <tr class="bg-light-gray">
                            <th>Fonte Pagadora</th>
                            <th>Valor L√≠quido</th>
                            <th>Informa√ß√£o</th>
                            <th>Data do Dado</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-rendimentos">
                        <!-- Linhas geradas dinamicamente -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Total</td>
                            <td><input class="form-control" type="text" id="rendimento-total-valor-liquido" readonly></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Se√ß√£o de Corre√ß√£o Monet√°ria -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Corre√ß√£o Monet√°ria</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="indice-correcao" class="form-label" style="color: inherit;">√çndice de Corre√ß√£o:</label>
                                <select id="indice-correcao" class="form-control">
                                    <option value="IPCA">IPCA</option>
                                    <option value="IGP-M">IGP-M</option>
                                    <option value="SELIC">SELIC</option>
                                    <option value="TR">TR</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="data-base-correcao" class="form-label" style="color: inherit;">Data Base:</label>
                                <input type="date" id="data-base-correcao" class="form-control" value="">
                            </div>
                            <div class="col-md-3">
                                <label for="data-atual-correcao" class="form-label" style="color: inherit;">Data Atual:</label>
                                <input type="date" id="data-atual-correcao" class="form-control" value="">
                            </div>
                            <div class="col-md-3 d-flex align-items-end gap-2">
                                <button type="button" class="btn btn-primary" onclick="aplicarCorrecaoMonetaria()">
                                    Aplicar Corre√ß√£o
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparCacheIndices()" title="Limpar cache de √≠ndices">
                                    üîÑ
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12 d-flex gap-2">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="visualizarHistoricoCorrecoes()">
                                    üìã Ver Hist√≥rico
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="limparHistoricoCorrecoes()">
                                    üóëÔ∏è Limpar Hist√≥rico
                                </button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info" style="color: inherit;">
                                    <strong style="color: inherit;">Instru√ß√µes:</strong> <span style="color: inherit;">Selecione o √≠ndice de corre√ß√£o, defina a data base (data de contrata√ß√£o) e a data atual. 
                                    O sistema aplicar√° a corre√ß√£o monet√°ria nos saldos devedores e salvar√° o resultado na coluna "Valor Corrigido", mantendo os valores originais intactos.</span>
                                    <br><br>
                                    <strong style="color: inherit;">Dados:</strong> <span style="color: inherit;">Os √≠ndices s√£o obtidos em tempo real da API do Banco Central. 
                                    Dados s√£o armazenados em cache por 24 horas para melhor performance. 
                                    Use o bot√£o üîÑ para for√ßar atualiza√ß√£o dos dados.</span>
                                    <br><br>
                                    <strong style="color: inherit;">Controle de Duplica√ß√£o:</strong> <span style="color: inherit;">O sistema evita automaticamente a aplica√ß√£o dupla da mesma corre√ß√£o. 
                                    Se uma corre√ß√£o com os mesmos par√¢metros j√° foi aplicada, voc√™ ser√° alertado. 
                                    Use "Ver Hist√≥rico" para consultar corre√ß√µes anteriores e "Limpar Hist√≥rico" se precisar reaplicar.</span>
                                    <br><br>
                                    <strong style="color: inherit;">Importante:</strong> <span style="color: inherit;">A corre√ß√£o monet√°ria √© aplicada no saldo devedor (valor contratado - valor pago) e o resultado √© salvo na coluna "Valor Corrigido". 
                                    Os saldos devedores originais permanecem inalterados para preservar os dados originais.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Bot√£o de tema pequeno e redondo -->
    <button id="btn-theme-toggle" type="button" title="Alternar tema" style="position:fixed;top:13px;right:8px;width:36px;height:36px;border-radius:50%;background:#e0ffe0;border:none;box-shadow:0 2px 8px #0002;display:flex;align-items:center;justify-content:center;font-size:1.2em;z-index:2000;cursor:pointer;transition:background 0.2s;">
      üåô
    </button>
    <div id="page-transition-overlay" style="display:block;"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const bancos = [
        '', 'Ita√∫', 'Bradesco', 'BMG RMG', 'Agibank', 'Banco do Brasil', 'Santander', 'Mercantil do Brasil', 'Sicob'
    ];

    document.addEventListener('DOMContentLoaded', function() {
        renderTabelaConsignados();
        renderTabelaNaoConsignados();
        renderTabelaSemParcelas();
        renderTabelaDividasConsolidadas();
    });

    window.onload = function() {
        // Restaurar valores dos campos de input e select
        document.querySelectorAll('input, select').forEach(function(el) {
            if (el.id && localStorage.getItem(el.id)) {
                el.value = localStorage.getItem(el.id);
            }
            // Adicionar listeners para salvar altera√ß√µes
            el.addEventListener('change', function() {
                if (this.id) localStorage.setItem(this.id, this.value);
            });
            el.addEventListener('input', function() {
                if (this.id) localStorage.setItem(this.id, this.value);
            });
        });

        // Preencher automaticamente a tabela de RENDIMENTOS com dados das receitas do index.html (din√¢mico)
        const receitasMap = [
            { fonte: 'Sal√°rios ganhos/l√≠quidos', id: 'receita-salarios' },
            { fonte: 'Ganho m√≠nimo como aut√¥nomo', id: 'receita-ganho-minimo' },
            { fonte: 'Aposentadoria', id: 'receita-aposentadoria' },
            { fonte: 'Pens√£o Previdenci√°ria (pens√£o por morte)', id: 'receita-pensao-previdenciaria' },
            { fonte: 'Aluguel', id: 'receita-aluguel' },
            { fonte: 'Pens√£o Aliment√≠cia (se descontada em folha de pagamento)', id: 'receita-pensao-alimenticia' },
            { fonte: 'Renda tempor√°ria', id: 'receita-renda-temporaria' },
            { fonte: 'Aux√≠lio por incapacidade', id: 'receita-auxilio-por-incapacidade' },
            { fonte: 'Auxilio acidente', id: 'receita-auxilio-acidente' },
            { fonte: 'Aux√≠lio reclus√£o', id: 'receita-auxilio-reclusao' },
            { fonte: 'Sal√°rio Maternidade', id: 'receita-salario-maternidade' },
            { fonte: 'Participa√ß√µes nos lucros ou comiss√µes', id: 'receita-participacoes-nos-lucros-ou-comissoes' },
            { fonte: '13¬∫ sal√°rio', id: 'receita-13-salario' },
            { fonte: 'Outros', id: 'receita-outros' }
        ];
        let totalRendimentos = 0;
        let linhasRendimentos = '';
        receitasMap.forEach(item => {
            const valor = localStorage.getItem(item.id);
            const evento = localStorage.getItem(item.id + '-evento') || '';
            const dataEvento = localStorage.getItem(item.id + '-evento-data') || '';
            if (valor && !isNaN(parseFloat(valor)) && parseFloat(valor) > 0) {
                linhasRendimentos += `<tr>` +
                    `<td><input class='form-control' type='text' value='${item.fonte}' readonly></td>` +
                    `<td><input class='form-control' type='text' value='${valor}' readonly></td>` +
                    `<td><input class='form-control' type='text' value='${evento}' readonly></td>` +
                    `<td><input class='form-control' type='text' value='${dataEvento}' readonly></td>` +
                `</tr>`;
                totalRendimentos += parseFloat(valor);
            }
        });
        document.getElementById('tbody-rendimentos').innerHTML = linhasRendimentos;
        document.getElementById('rendimento-total-valor-liquido').value = totalRendimentos > 0 ? totalRendimentos.toFixed(2) : '';

        // Ativa o bot√£o da p√°gina atual
        const page = window.location.pathname.split('/').pop();
        document.getElementById('btn-dados').classList.remove('active');
        document.getElementById('btn-geral').classList.remove('active');
        document.getElementById('btn-plano').classList.remove('active');
        document.getElementById('btn-panorama').classList.remove('active');
        if(page.includes('index')) document.getElementById('btn-dados').classList.add('active');
        if(page.includes('geral')) document.getElementById('btn-geral').classList.add('active');
        if(page.includes('plano-de-pagamento')) document.getElementById('btn-plano').classList.add('active');
        if(page.includes('panorama')) document.getElementById('btn-panorama').classList.add('active');

        // Inicializar tabela de consignados
        renderTabelaConsignados();
        
        // Inicializar c√°lculos autom√°ticos
        const linhas = [
            'nao-consignado-1', 'nao-consignado-2',
            'sem-parcela-1',
            'divida-consolidada-1', 'divida-consolidada-2'
        ];
        linhas.forEach(function(prefix) {
            const contratado = document.getElementById(prefix+'-valor-contratado');
            const pago = document.getElementById(prefix+'-valor-pago');
            if (contratado && pago) {
                contratado.addEventListener('input', function() { atualizarSaldoDevedor(prefix); });
                pago.addEventListener('input', function() { atualizarSaldoDevedor(prefix); });
                // Inicializa ao carregar
                atualizarSaldoDevedor(prefix);
            }
        });

        // Ap√≥s atualizar os valores do localStorage (exemplo: no final da fun√ß√£o que preenche os campos principais)
        document.querySelectorAll('.conteudo-escondido').forEach(function(el) {
            el.classList.remove('conteudo-escondido');
        });
        // Esconde o overlay de carregamento
        var overlay = document.getElementById('page-load-overlay');
        if (overlay) {
            overlay.classList.add('hide');
            setTimeout(function() { overlay.style.display = 'none'; }, 400);
        }
    };

    function limparCampos() {
        if (!confirm('Tem certeza que deseja limpar todos os dados?')) {
            return;
        }
        // Limpar todos os campos do formul√°rio
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(function(input) {
            input.value = '';
            if (input.id) localStorage.removeItem(input.id);
        });
        // Limpar todos os selects (dropdowns)
        document.querySelectorAll('select').forEach(function(select) {
            select.value = '';
            if (select.id) localStorage.removeItem(select.id);
        });
        // Limpar linhas din√¢micas de consignados
        localStorage.removeItem('linhas-consignados');
        localStorage.removeItem('linhas-nao-consignados');
        localStorage.removeItem('linhas-sem-parcelas');
        localStorage.removeItem('linhas-dividas-consolidadas');
        // Limpar apenas os campos de input relacionados √† geral.html
        const geralKeys = [
            'nome-consumidor',
            'numero-processo',
            // Adicione aqui outros IDs de campos exclusivos da geral.html, se houver
        ];
        geralKeys.forEach(key => localStorage.removeItem(key));
        // Renderizar as tabelas vazias
        renderTabelaConsignados();
        renderTabelaNaoConsignados();
        renderTabelaSemParcelas();
        renderTabelaDividasConsolidadas();
        // Atualizar totais
        atualizarTotaisConsignados();
        atualizarTotaisNaoConsignados();
        atualizarTotaisSemParcelas();
        atualizarTotaisDividasConsolidadas();
        // Limpar rendimentos da tabela
        document.getElementById('tbody-rendimentos').innerHTML = '';
        document.getElementById('rendimento-total-valor-liquido').value = '';
    }

    function atualizarSaldoDevedor(prefix) {
        const valorContratado = parseFloat(document.getElementById(prefix+'-valor-contratado').value);
        const valorPago = parseFloat(document.getElementById(prefix+'-valor-pago').value);
        let saldo = '';
        if (!isNaN(valorContratado) && !isNaN(valorPago)) {
            saldo = (valorContratado - valorPago).toFixed(2);
        }
        document.getElementById(prefix+'-saldo-devedor').value = saldo;
        localStorage.setItem(prefix+'-saldo-devedor', saldo);
    }

    function atualizarTotaisConsignados() {
        let linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        document.getElementById('total-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        document.getElementById('total-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        document.getElementById('total-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        document.getElementById('total-juros').textContent = '';
        document.getElementById('total-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function formatarJuros(valor) {
        if (!valor) return '';
        valor = valor.toString().replace('%','').replace(',','.');
        if (valor === '') return '';
        if (isNaN(valor)) return '';
        return parseFloat(valor) + '%';
    }

    function atualizarListenersConsignados() {
        const tbody = document.getElementById('tbody-consignados');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            
            // Listener para dropdown do credor
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        // Se selecionar 'Selecione', remove a linha
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
                        renderTabelaConsignados();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
                    renderTabelaConsignados();
                });
            }
            
            // Listeners para inputs
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'valorCorrigido', 'dataContratacao', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        
                        // Se for valor contratado ou valor pago, recalcular saldo devedor
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            
                            // Atualizar o campo de saldo devedor na interface
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        
                        localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
                        atualizarTotaisConsignados();
                    }
                });
            });
        });
    }

    function renderTabelaConsignados() {
        const tbody = document.getElementById('tbody-consignados');
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
        
        // Remove linhas totalmente vazias exceto a √∫ltima
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        
        // Garante sempre uma linha vazia ao final
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        
        // Renderiza cada linha
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaConsignado(linha);
        });
        
        // Salva o estado atual das linhas
        localStorage.setItem('linhas-consignados', JSON.stringify(linhas));
        
        // Atualiza os listeners e totais
        atualizarListenersConsignados();
        atualizarTotaisConsignados();
        applyDarkThemeToTableRows();
    }

    function criarLinhaConsignado(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control valor-corrigido" type="text" value="${dados.valorCorrigido || ''}" readonly></td>
            <td><input class="form-control" type="date" value="${dados.dataContratacao || ''}"></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // --- N√ÉO CONSIGNADOS ---
    function atualizarListenersNaoConsignados() {
        const tbody = document.getElementById('tbody-nao-consignados');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
                        renderTabelaNaoConsignados();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
                    renderTabelaNaoConsignados();
                });
            }
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'valorCorrigido', 'dataContratacao', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
                        atualizarTotaisNaoConsignados();
                    }
                });
            });
        });
    }

    function atualizarTotaisNaoConsignados() {
        let linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        // Exibir os totais no rodap√© da tabela NAO CONSIGNADOS
        if(document.getElementById('total-nao-consignados-valor-contratado'))
            document.getElementById('total-nao-consignados-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        if(document.getElementById('total-nao-consignados-valor-pago'))
            document.getElementById('total-nao-consignados-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        if(document.getElementById('total-nao-consignados-saldo-devedor'))
            document.getElementById('total-nao-consignados-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        if(document.getElementById('total-nao-consignados-parcela-mensal'))
            document.getElementById('total-nao-consignados-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function renderTabelaNaoConsignados() {
        const tbody = document.getElementById('tbody-nao-consignados');
        if (!tbody) return;
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
        // Remove linhas totalmente vazias exceto a √∫ltima
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        // Garante sempre uma linha vazia ao final
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaNaoConsignado(linha);
        });
        localStorage.setItem('linhas-nao-consignados', JSON.stringify(linhas));
        atualizarListenersNaoConsignados();
        atualizarTotaisNaoConsignados();
        applyDarkThemeToTableRows();
    }

    function criarLinhaNaoConsignado(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control valor-corrigido" type="text" value="${dados.valorCorrigido || ''}" readonly></td>
            <td><input class="form-control" type="date" value="${dados.dataContratacao || ''}"></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // --- SEM PARCELAS ---
    function atualizarListenersSemParcelas() {
        const tbody = document.getElementById('tbody-sem-parcelas');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
                        renderTabelaSemParcelas();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
                    renderTabelaSemParcelas();
                });
            }
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'valorCorrigido', 'dataContratacao', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
                        atualizarTotaisSemParcelas();
                    }
                });
            });
        });
    }

    function atualizarTotaisSemParcelas() {
        let linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        if(document.getElementById('total-sem-parcelas-valor-contratado'))
            document.getElementById('total-sem-parcelas-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        if(document.getElementById('total-sem-parcelas-valor-pago'))
            document.getElementById('total-sem-parcelas-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        if(document.getElementById('total-sem-parcelas-saldo-devedor'))
            document.getElementById('total-sem-parcelas-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        if(document.getElementById('total-sem-parcelas-parcela-mensal'))
            document.getElementById('total-sem-parcelas-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function renderTabelaSemParcelas() {
        const tbody = document.getElementById('tbody-sem-parcelas');
        if (!tbody) return;
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaSemParcela(linha);
        });
        localStorage.setItem('linhas-sem-parcelas', JSON.stringify(linhas));
        atualizarListenersSemParcelas();
        atualizarTotaisSemParcelas();
        applyDarkThemeToTableRows();
    }

    function criarLinhaSemParcela(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control valor-corrigido" type="text" value="${dados.valorCorrigido || ''}" readonly></td>
            <td><input class="form-control" type="date" value="${dados.dataContratacao || ''}"></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // --- D√çVIDAS CONSOLIDADAS ---
    function atualizarListenersDividasConsolidadas() {
        const tbody = document.getElementById('tbody-dividas-consolidadas');
        const trs = tbody.querySelectorAll('tr');
        trs.forEach((tr, idx) => {
            const selects = tr.querySelectorAll('select');
            const inputs = tr.querySelectorAll('input');
            if (selects[0]) {
                selects[0].addEventListener('change', function() {
                    let linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    if (this.value === '') {
                        linhas.splice(idx, 1);
                        localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
                        renderTabelaDividasConsolidadas();
                        return;
                    }
                    linhas[idx].credor = this.value;
                    localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
                    renderTabelaDividasConsolidadas();
                });
            }
            inputs.forEach((input, i) => {
                input.addEventListener('input', function() {
                    const linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
                    if (!linhas[idx]) linhas[idx] = {};
                    const campos = ['contratos', 'valorContratado', 'valorPago', 'saldoDevedor', 'valorCorrigido', 'dataContratacao', 'juros', 'parcelaMensal', 'parcelasContratadas', 'parcelasRestantes'];
                    const campo = campos[i];
                    if (campo) {
                        linhas[idx][campo] = this.value;
                        if (campo === 'valorContratado' || campo === 'valorPago') {
                            const valorContratado = parseFloat(linhas[idx].valorContratado) || 0;
                            const valorPago = parseFloat(linhas[idx].valorPago) || 0;
                            linhas[idx].saldoDevedor = (valorContratado - valorPago).toFixed(2);
                            const saldoInput = tr.querySelector('.saldo-devedor');
                            if (saldoInput) {
                                saldoInput.value = linhas[idx].saldoDevedor;
                            }
                        }
                        localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
                        atualizarTotaisDividasConsolidadas();
                    }
                });
            });
        });
    }

    function atualizarTotaisDividasConsolidadas() {
        let linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
        let totalValorContratado = 0, totalValorPago = 0, totalSaldoDevedor = 0, totalParcelaMensal = 0;
        linhas.forEach(linha => {
            if (linha.credor && linha.credor !== '') {
                totalValorContratado += parseFloat(linha.valorContratado) || 0;
                totalValorPago += parseFloat(linha.valorPago) || 0;
                totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
                totalParcelaMensal += parseFloat(linha.parcelaMensal) || 0;
            }
        });
        if(document.getElementById('total-dividas-consolidadas-valor-contratado'))
            document.getElementById('total-dividas-consolidadas-valor-contratado').textContent = totalValorContratado ? totalValorContratado.toFixed(2) : '';
        if(document.getElementById('total-dividas-consolidadas-valor-pago'))
            document.getElementById('total-dividas-consolidadas-valor-pago').textContent = totalValorPago ? totalValorPago.toFixed(2) : '';
        if(document.getElementById('total-dividas-consolidadas-saldo-devedor'))
            document.getElementById('total-dividas-consolidadas-saldo-devedor').textContent = totalSaldoDevedor ? totalSaldoDevedor.toFixed(2) : '';
        if(document.getElementById('total-dividas-consolidadas-parcela-mensal'))
            document.getElementById('total-dividas-consolidadas-parcela-mensal').textContent = totalParcelaMensal ? totalParcelaMensal.toFixed(2) : '';
    }

    function renderTabelaDividasConsolidadas() {
        const tbody = document.getElementById('tbody-dividas-consolidadas');
        if (!tbody) return;
        tbody.innerHTML = '';
        let linhas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
        linhas = linhas.filter((linha, idx) => {
            if (idx === linhas.length - 1) return true;
            return Object.values(linha).some(v => v && v !== '');
        });
        if (!linhas.length || Object.values(linhas[linhas.length-1] || {}).some(v => v && v !== '')) {
            linhas.push({});
        }
        linhas.forEach((linha, idx) => {
            tbody.innerHTML += criarLinhaDividaConsolidada(linha);
        });
        localStorage.setItem('linhas-dividas-consolidadas', JSON.stringify(linhas));
        atualizarListenersDividasConsolidadas();
        atualizarTotaisDividasConsolidadas();
        applyDarkThemeToTableRows();
    }

    function criarLinhaDividaConsolidada(dados = {}) {
        return `<tr>
            <td><select class="form-select credor-select">${bancos.map(b => `<option value="${b}"${dados.credor === b ? ' selected' : ''}>${b ? b : 'Selecione'}</option>`).join('')}</select></td>
            <td><input class="form-control" type="text" value="${dados.contratos || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorContratado || ''}"></td>
            <td><input class="form-control" type="number" step="0.01" value="${dados.valorPago || ''}"></td>
            <td><input class="form-control saldo-devedor" type="text" value="${dados.saldoDevedor || ''}" readonly></td>
            <td><input class="form-control valor-corrigido" type="text" value="${dados.valorCorrigido || ''}" readonly></td>
            <td><input class="form-control" type="date" value="${dados.dataContratacao || ''}"></td>
            <td><input class="form-control juros-input" type="text" value="${dados.juros || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelaMensal || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasContratadas || ''}"></td>
            <td><input class="form-control" type="text" value="${dados.parcelasRestantes || ''}"></td>
        </tr>`;
    }

    // === DARK MODE (copiado/adaptado da index.html) ===
    const themeToggleBtn = document.getElementById('btn-theme-toggle');
    function setTheme(dark) {
        if (dark) {
            document.body.classList.add('dark-theme');
            document.querySelectorAll('.container').forEach(el => el.classList.add('dark-theme'));
            document.querySelectorAll('.container, #custom-navbar, .nav-btn, table, th, td, thead, .table-light, .table-title, input, select, textarea, .btn, .btn-success, .btn-warning, .btn-primary, .btn-danger, .btn-info, .form-check-input, .valor-final, .obs, h1, h2, h3, h4, h5, h6').forEach(el => el.classList.add('dark-theme'));
            document.querySelectorAll('tfoot, tfoot tr, tfoot .total-row').forEach(el => el.classList.add('dark-theme'));
            themeToggleBtn.textContent = '\u2600\ufe0f';
            localStorage.setItem('theme', 'dark');
            // For√ßa dark-theme em todos os th e td das tabelas
            document.querySelectorAll('table').forEach(table => {
                table.querySelectorAll('th, td').forEach(cell => cell.classList.add('dark-theme'));
            });
        } else {
            document.body.classList.remove('dark-theme');
            document.querySelectorAll('.container').forEach(el => el.classList.remove('dark-theme'));
            document.querySelectorAll('.container, #custom-navbar, .nav-btn, table, th, td, thead, .table-light, .table-title, input, select, textarea, .btn, .btn-success, .btn-warning, .btn-primary, .btn-danger, .btn-info, .form-check-input, .valor-final, .obs, h1, h2, h3, h4, h5, h6').forEach(el => el.classList.remove('dark-theme'));
            document.querySelectorAll('tfoot, tfoot tr, tfoot .total-row').forEach(el => el.classList.remove('dark-theme'));
            themeToggleBtn.textContent = '\ud83c\udf19';
            localStorage.setItem('theme', 'light');
            // Remove dark-theme de todos os th e td das tabelas
            document.querySelectorAll('table').forEach(table => {
                table.querySelectorAll('th, td').forEach(cell => cell.classList.remove('dark-theme'));
            });
        }
    }
    themeToggleBtn.addEventListener('click', function() {
        const dark = !document.documentElement.classList.contains('dark-theme');
        localStorage.setItem('theme', dark ? 'dark' : 'light');
        location.reload();
    });
    window.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            const saved = localStorage.getItem('theme');
            setTheme(saved === 'dark');
        }, 0);
    });
    function trocarLogoPorTema(dark) {
        var logo = document.getElementById('logo-superend');
        if (!logo) return;
        logo.src = dark ? 'logo-superendividamento-Dark.png' : 'logo-superendividamento.png';
    }
    function trocarBgPorTema(dark) {
        document.body.style.backgroundImage = dark ? "url('SuperEndBackgroundTransparente-Dark.png')" : "url('SuperEndBackgroundTransparente.png')";
    }
    // Adapte a fun√ß√£o setTheme existente:
    const oldSetTheme = setTheme;
    setTheme = function(dark) {
        oldSetTheme(dark);
        trocarLogoPorTema(dark);
        trocarBgPorTema(dark);
    }
    window.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            const saved = localStorage.getItem('theme');
            trocarLogoPorTema(saved === 'dark');
            trocarBgPorTema(saved === 'dark');
        }, 0);
    });

    // Aplica a classe dark-theme a todas as linhas, c√©lulas, inputs e selects das tabelas se o tema escuro estiver ativo
    function applyDarkThemeToTableRows() {
        if (!document.body.classList.contains('dark-theme')) return;
        document.querySelectorAll('.table').forEach(table => {
            table.classList.add('dark-theme');
            table.querySelectorAll('tr').forEach(tr => tr.classList.add('dark-theme'));
            table.querySelectorAll('th, td').forEach(cell => cell.classList.add('dark-theme'));
            table.querySelectorAll('input, select, textarea').forEach(input => input.classList.add('dark-theme'));
        });
    }

    // Adicionar fun√ß√£o global:
    function navegarComTema(destino) {
        var overlay = document.getElementById('page-transition-overlay');
        if (overlay) {
            overlay.style.display = 'block';
            overlay.classList.add('active');
            setTimeout(function() {
                window.location.href = destino;
            }, 350);
        } else {
            window.location.href = destino;
        }
    }

    // --- CORRE√á√ÉO MONET√ÅRIA ---
    
    // C√≥digos dos √≠ndices na API do Banco Central
    const codigosIndicesBC = {
        'IPCA': 433,      // IPCA - √çndice Nacional de Pre√ßos ao Consumidor Amplo
        'IGP-M': 189,     // IGP-M - √çndice Geral de Pre√ßos do Mercado
        'SELIC': 11,      // Taxa de juros - Meta Selic definida pelo Comit√™ de Pol√≠tica Monet√°ria
        'TR': 226         // Taxa Referencial - TR
    };

    // Cache local para os dados dos √≠ndices
    let cacheIndices = JSON.parse(localStorage.getItem('cache-indices') || '{}');
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas em milissegundos

    async function buscarIndiceBC(indice, dataInicio, dataFim) {
        const codigo = codigosIndicesBC[indice];
        if (!codigo) {
            throw new Error(`√çndice ${indice} n√£o suportado`);
        }

        // Verificar cache primeiro
        const chaveCache = `${indice}_${dataInicio}_${dataFim}`;
        const cacheItem = cacheIndices[chaveCache];
        
        if (cacheItem && (Date.now() - cacheItem.timestamp) < CACHE_DURATION) {
            console.log(`Usando dados em cache para ${indice}`);
            return cacheItem.dados;
        }

        try {
            console.log(`Buscando dados do BC para ${indice}...`);
            
            const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${codigo}/dados?formato=json&dataInicial=${dataInicio}&dataFinal=${dataFim}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Erro na API do BC: ${response.status} ${response.statusText}`);
            }
            
            const dados = await response.json();
            
            // Armazenar no cache
            cacheIndices[chaveCache] = {
                dados: dados,
                timestamp: Date.now()
            };
            localStorage.setItem('cache-indices', JSON.stringify(cacheIndices));
            
            console.log(`Dados obtidos com sucesso para ${indice}: ${dados.length} registros`);
            return dados;
            
        } catch (error) {
            console.error(`Erro ao buscar dados do BC para ${indice}:`, error);
            
            // Retornar dados de fallback se dispon√≠vel
            return getDadosFallback(indice, dataInicio, dataFim);
        }
    }

    // Dados de fallback para casos de erro na API
    function getDadosFallback(indice, dataInicio, dataFim) {
        const dadosFallback = {
            'IPCA': {
                '2023-01': 0.53, '2023-02': 0.84, '2023-03': 0.71, '2023-04': 0.61,
                '2023-05': 0.23, '2023-06': 0.13, '2023-07': 0.12, '2023-08': 0.23,
                '2023-09': 0.26, '2023-10': 0.24, '2023-11': 0.28, '2023-12': 0.56,
                '2024-01': 0.42, '2024-02': 0.83, '2024-03': 0.36, '2024-04': 0.38,
                '2024-05': 0.46, '2024-06': 0.39, '2024-07': 0.17, '2024-08': 0.44,
                '2024-09': 0.26, '2024-10': 0.24, '2024-11': 0.51, '2024-12': 0.56
            },
            'IGP-M': {
                '2023-01': -0.52, '2023-02': 0.16, '2023-03': -0.78, '2023-04': -1.12,
                '2023-05': -1.66, '2023-06': -1.18, '2023-07': -0.53, '2023-08': 0.28,
                '2023-09': 0.95, '2023-10': 0.09, '2023-11': 0.74, '2023-12': 0.74,
                '2024-01': 0.52, '2024-02': 0.60, '2024-03': 0.71, '2024-04': 0.59,
                '2024-05': 0.59, '2024-06': 0.70, '2024-07': 0.41, '2024-08': 0.59,
                '2024-09': 0.59, '2024-10': 0.59, '2024-11': 0.59, '2024-12': 0.59
            },
            'SELIC': {
                '2023-01': 13.75, '2023-02': 13.75, '2023-03': 13.75, '2023-04': 13.75,
                '2023-05': 13.75, '2023-06': 13.75, '2023-07': 13.75, '2023-08': 13.25,
                '2023-09': 12.75, '2023-10': 12.25, '2023-11': 11.75, '2023-12': 11.25,
                '2024-01': 11.25, '2024-02': 11.25, '2024-03': 10.75, '2024-04': 10.50,
                '2024-05': 10.50, '2024-06': 10.50, '2024-07': 10.50, '2024-08': 10.50,
                '2024-09': 10.50, '2024-10': 10.50, '2024-11': 10.50, '2024-12': 10.50
            },
            'TR': {
                '2023-01': 0.01, '2023-02': 0.01, '2023-03': 0.01, '2023-04': 0.01,
                '2023-05': 0.01, '2023-06': 0.01, '2023-07': 0.01, '2023-08': 0.01,
                '2023-09': 0.01, '2023-10': 0.01, '2023-11': 0.01, '2023-12': 0.01,
                '2024-01': 0.01, '2024-02': 0.01, '2024-03': 0.01, '2024-04': 0.01,
                '2024-05': 0.01, '2024-06': 0.01, '2024-07': 0.01, '2024-08': 0.01,
                '2024-09': 0.01, '2024-10': 0.01, '2024-11': 0.01, '2024-12': 0.01
            }
        };

        const dados = dadosFallback[indice];
        if (!dados) return [];

        // Converter dados de fallback para formato da API
        const resultado = [];
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        const dataAtual = new Date(inicio);

        while (dataAtual <= fim) {
            const chave = `${dataAtual.getFullYear()}-${String(dataAtual.getMonth() + 1).padStart(2, '0')}`;
            const valor = dados[chave];
            
            if (valor !== undefined) {
                resultado.push({
                    data: dataAtual.toISOString().split('T')[0],
                    valor: valor
                });
            }
            
            dataAtual.setMonth(dataAtual.getMonth() + 1);
        }

        return resultado;
    }

    function processarDadosIndice(dados, indice) {
        const indicesProcessados = {};
        
        dados.forEach(item => {
            const data = new Date(item.data);
            const chave = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
            
            if (indice === 'SELIC') {
                // SELIC vem como taxa anual, converter para mensal
                indicesProcessados[chave] = parseFloat(item.valor) / 12;
            } else {
                // Outros √≠ndices j√° v√™m como percentual mensal
                indicesProcessados[chave] = parseFloat(item.valor);
            }
        });
        
        return indicesProcessados;
    }

    async function calcularFatorCorrecao(dataInicio, dataFim, indice) {
        if (!dataInicio || !dataFim || !indice) return 1;
        
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        
        if (inicio >= fim) return 1;
        
        try {
            // Formatar datas para a API (DD/MM/YYYY)
            const dataInicioFormatada = `${inicio.getDate().toString().padStart(2, '0')}/${(inicio.getMonth() + 1).toString().padStart(2, '0')}/${inicio.getFullYear()}`;
            const dataFimFormatada = `${fim.getDate().toString().padStart(2, '0')}/${(fim.getMonth() + 1).toString().padStart(2, '0')}/${fim.getFullYear()}`;
            
            // Buscar dados da API
            const dados = await buscarIndiceBC(indice, dataInicioFormatada, dataFimFormatada);
            
            if (!dados || dados.length === 0) {
                console.warn('Nenhum dado encontrado para o per√≠odo selecionado');
                return 1;
            }
            
            // Processar dados
            const indicesProcessados = processarDadosIndice(dados, indice);
            
            // Calcular fator de corre√ß√£o acumulado
            let fator = 1;
            const dataAtual = new Date(inicio);
            dataAtual.setMonth(dataAtual.getMonth() + 1); // Come√ßar do m√™s seguinte
            
            while (dataAtual <= fim) {
                const chave = `${dataAtual.getFullYear()}-${String(dataAtual.getMonth() + 1).padStart(2, '0')}`;
                const valorIndice = indicesProcessados[chave];
                
                if (valorIndice !== undefined) {
                    if (indice === 'SELIC') {
                        // Para SELIC, usar taxa mensal
                        fator *= (1 + (valorIndice / 100));
                    } else {
                        // Para outros √≠ndices, usar percentual mensal
                        fator *= (1 + (valorIndice / 100));
                    }
                }
                
                dataAtual.setMonth(dataAtual.getMonth() + 1);
            }
            
            return fator;
            
        } catch (error) {
            console.error('Erro ao calcular fator de corre√ß√£o:', error);
            alert(`Erro ao calcular corre√ß√£o monet√°ria: ${error.message}\n\nUsando dados de fallback...`);
            return 1;
        }
    }

    async function aplicarCorrecaoMonetaria() {
        const indice = document.getElementById('indice-correcao').value;
        const dataBase = document.getElementById('data-base-correcao').value;
        const dataAtual = document.getElementById('data-atual-correcao').value;
        
        if (!dataBase || !dataAtual) {
            alert('Por favor, preencha as datas de in√≠cio e fim para a corre√ß√£o monet√°ria.');
            return;
        }
        
        if (new Date(dataBase) >= new Date(dataAtual)) {
            alert('A data base deve ser anterior √† data atual.');
            return;
        }
        
        // Verificar se j√° existe corre√ß√£o aplicada
        const historicoCorrecoes = JSON.parse(localStorage.getItem('historico-correcoes') || '[]');
        const correcaoExistente = historicoCorrecoes.find(c => 
            c.indice === indice && 
            c.dataBase === dataBase && 
            c.dataAtual === dataAtual
        );
        
        if (correcaoExistente) {
            const confirmacao = confirm(
                `Uma corre√ß√£o monet√°ria com os mesmos par√¢metros j√° foi aplicada em ${new Date(correcaoExistente.timestamp).toLocaleString()}.\n\n` +
                `√çndice: ${indice}\n` +
                `Per√≠odo: ${dataBase} a ${dataAtual}\n` +
                `Fator aplicado: ${correcaoExistente.fatorCorrecao}\n\n` +
                `Deseja aplicar a corre√ß√£o novamente? Isso pode resultar em corre√ß√£o dupla.`
            );
            
            if (!confirmacao) {
                return;
            }
        }
        
        // Mostrar indicador de carregamento
        const btnCorrecao = document.querySelector('button[onclick="aplicarCorrecaoMonetaria()"]');
        const textoOriginal = btnCorrecao.textContent;
        btnCorrecao.textContent = 'Calculando...';
        btnCorrecao.disabled = true;
        
        try {
            const fatorCorrecao = await calcularFatorCorrecao(dataBase, dataAtual, indice);
            
            if (fatorCorrecao === 1) {
                alert('N√£o foi poss√≠vel calcular a corre√ß√£o monet√°ria para o per√≠odo selecionado.');
                return;
            }
            
            // Aplicar corre√ß√£o em todas as tabelas
            const tabelas = [
                'linhas-consignados',
                'linhas-nao-consignados', 
                'linhas-sem-parcelas',
                'linhas-dividas-consolidadas'
            ];
            
            let totalCorrigido = 0;
            let totalOriginal = 0;
            let itensCorrigidos = 0;
            
            tabelas.forEach(tabela => {
                let linhas = JSON.parse(localStorage.getItem(tabela) || '[]');
                let modificado = false;
                
                linhas.forEach(linha => {
                    if (linha.valorContratado && parseFloat(linha.valorContratado) > 0) {
                        // Verificar se o valor j√° foi corrigido para este per√≠odo
                        const chaveCorrecao = `${indice}_${dataBase}_${dataAtual}`;
                        if (linha.correcoesAplicadas && linha.correcoesAplicadas.includes(chaveCorrecao)) {
                            console.log(`Valor j√° corrigido para ${chaveCorrecao}, pulando...`);
                            return;
                        }
                        
                        const valorContratado = parseFloat(linha.valorContratado);
                        const valorPago = parseFloat(linha.valorPago) || 0;
                        const saldoDevedorOriginal = valorContratado - valorPago;
                        
                        // Aplicar corre√ß√£o APENAS no saldo devedor
                        const saldoDevedorCorrigido = saldoDevedorOriginal * fatorCorrecao;
                        
                        // O saldo devedor permanece inalterado
                        // O valor corrigido √© salvo na nova coluna
                        linha.valorCorrigido = saldoDevedorCorrigido.toFixed(2);
                        
                        // Registrar corre√ß√£o aplicada
                        if (!linha.correcoesAplicadas) {
                            linha.correcoesAplicadas = [];
                        }
                        linha.correcoesAplicadas.push(chaveCorrecao);
                        
                        totalOriginal += saldoDevedorOriginal;
                        totalCorrigido += saldoDevedorCorrigido;
                        itensCorrigidos++;
                        modificado = true;
                    }
                });
                
                if (modificado) {
                    localStorage.setItem(tabela, JSON.stringify(linhas));
                }
            });
            
            // Registrar no hist√≥rico de corre√ß√µes
            const novaCorrecao = {
                indice: indice,
                dataBase: dataBase,
                dataAtual: dataAtual,
                fatorCorrecao: fatorCorrecao,
                timestamp: Date.now(),
                itensCorrigidos: itensCorrigidos,
                totalOriginal: totalOriginal,
                totalCorrigido: totalCorrigido
            };
            
            historicoCorrecoes.push(novaCorrecao);
            localStorage.setItem('historico-correcoes', JSON.stringify(historicoCorrecoes));
            
            // Recarregar todas as tabelas
            renderTabelaConsignados();
            renderTabelaNaoConsignados();
            renderTabelaSemParcelas();
            renderTabelaDividasConsolidadas();
            
            // Mostrar resultado
            const diferenca = totalCorrigido - totalOriginal;
            const percentual = ((fatorCorrecao - 1) * 100).toFixed(2);
            
            alert(`Corre√ß√£o monet√°ria aplicada com sucesso!\n\n` +
                  `√çndice: ${indice}\n` +
                  `Per√≠odo: ${dataBase} a ${dataAtual}\n` +
                  `Fator de corre√ß√£o: ${fatorCorrecao.toFixed(4)}\n` +
                  `Percentual: ${percentual}%\n\n` +
                  `Itens corrigidos: ${itensCorrigidos}\n` +
                  `Saldo devedor original total: R$ ${totalOriginal.toFixed(2)}\n` +
                  `Valor corrigido total: R$ ${totalCorrigido.toFixed(2)}\n` +
                  `Diferen√ßa: R$ ${diferenca.toFixed(2)}\n\n` +
                  `A corre√ß√£o foi aplicada e salva na coluna "Valor Corrigido".\n` +
                  `Os saldos devedores originais permaneceram inalterados.\n\n` +
                  `A corre√ß√£o foi registrada no hist√≥rico para evitar duplica√ß√£o.`);
                  
        } catch (error) {
            console.error('Erro na corre√ß√£o monet√°ria:', error);
            alert(`Erro ao aplicar corre√ß√£o monet√°ria: ${error.message}`);
        } finally {
            // Restaurar bot√£o
            btnCorrecao.textContent = textoOriginal;
            btnCorrecao.disabled = false;
        }
    }

    // Fun√ß√£o para visualizar hist√≥rico de corre√ß√µes
    function visualizarHistoricoCorrecoes() {
        const historico = JSON.parse(localStorage.getItem('historico-correcoes') || '[]');
        
        if (historico.length === 0) {
            alert('Nenhuma corre√ß√£o monet√°ria foi aplicada ainda.');
            return;
        }
        
        let mensagem = 'HIST√ìRICO DE CORRE√á√ïES MONET√ÅRIAS:\n\n';
        
        historico.forEach((correcao, index) => {
            const data = new Date(correcao.timestamp).toLocaleString();
            const percentual = ((correcao.fatorCorrecao - 1) * 100).toFixed(2);
            const diferenca = correcao.totalCorrigido - correcao.totalOriginal;
            
            mensagem += `${index + 1}. ${data}\n` +
                       `   √çndice: ${correcao.indice}\n` +
                       `   Per√≠odo: ${correcao.dataBase} a ${correcao.dataAtual}\n` +
                       `   Fator: ${correcao.fatorCorrecao.toFixed(4)} (${percentual}%)\n` +
                       `   Itens: ${correcao.itensCorrigidos}\n` +
                       `   Saldo devedor original: R$ ${correcao.totalOriginal.toFixed(2)}\n` +
                       `   Valor corrigido: R$ ${correcao.totalCorrigido.toFixed(2)}\n` +
                       `   Diferen√ßa: R$ ${diferenca.toFixed(2)}\n\n`;
        });
        
        alert(mensagem);
    }

    // Fun√ß√£o para limpar hist√≥rico de corre√ß√µes
    function limparHistoricoCorrecoes() {
        const confirmacao = confirm(
            'Tem certeza que deseja limpar todo o hist√≥rico de corre√ß√µes monet√°rias?\n\n' +
            'Isso permitir√° que as corre√ß√µes sejam aplicadas novamente, mas pode resultar em corre√ß√£o dupla se n√£o for feito com cuidado.'
        );
        
        if (confirmacao) {
            localStorage.removeItem('historico-correcoes');
            
            // Limpar tamb√©m os registros de corre√ß√µes aplicadas nas linhas
            const tabelas = [
                'linhas-consignados',
                'linhas-nao-consignados', 
                'linhas-sem-parcelas',
                'linhas-dividas-consolidadas'
            ];
            
            tabelas.forEach(tabela => {
                let linhas = JSON.parse(localStorage.getItem(tabela) || '[]');
                linhas.forEach(linha => {
                    if (linha.correcoesAplicadas) {
                        delete linha.correcoesAplicadas;
                    }
                });
                localStorage.setItem(tabela, JSON.stringify(linhas));
            });
            
            alert('Hist√≥rico de corre√ß√µes limpo com sucesso.');
        }
    }

    // Fun√ß√£o para limpar cache (√∫til para for√ßar atualiza√ß√£o)
    function limparCacheIndices() {
        localStorage.removeItem('cache-indices');
        cacheIndices = {};
        alert('Cache de √≠ndices limpo. Os pr√≥ximos c√°lculos usar√£o dados atualizados.');
    }

    // Inicializar data atual no carregamento da p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data-atual-correcao').value = hoje;
    });
    </script>
</body>
</html> 