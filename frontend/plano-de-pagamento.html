<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Pagamento - Superendividamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: url('SuperEndBackgroundTransparente.png') no-repeat center center fixed;
            background-size: cover;
        }
        .container { max-width: 1400px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h1 { color: #2d5c2f; margin-bottom: 30px; }
        table { font-size: 0.88rem; }
        th, td { padding: 0.3em 0.5em !important; vertical-align: middle !important; }
        .table-bordered th, .table-bordered td {
            border-width: 1px !important;
            border-style: solid !important;
            border-color: #333 !important;
        }
        .table th, .table td {
            border-width: 1px !important;
            border-style: solid !important;
            border-color: #333 !important;
        }
        .total-row { font-weight: bold; background: #f0f0f0; }
        .subtotal-row { font-weight: bold; background: #e0e0e0; }
        .input-sm { max-width: 80px; }
        .input-xs { max-width: 60px; }
        .input-md { max-width: 120px; }
        .input-lg { max-width: 180px; }
        .bg-light-green { background: #eaffea; }
        .bg-light-blue { background: #eaf4ff; }
        .bg-light-yellow { background: #fffbe6; }
        .text-green { color: #007a00; }
        .text-blue { color: #0057b7; }
        .text-red { color: #d00; }
        .scroll-x { overflow-x: auto; }
        .bg-medium-gray { background: #dee2e6 !important; }
        @media (max-width: 900px) {
            .row { flex-direction: column; }
            .container { padding: 10px; }
        }
        #custom-navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            background: linear-gradient(90deg, #e0ffe0 0%, #baffba 100%);
            box-shadow: 0 2px 8px #0002;
            border-radius: 0 0 16px 16px;
            padding: 6px 8px;
            margin-bottom: 18px;
            border: none;
        }
        .nav-btn {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 1em;
            padding: 10px 0;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, font-weight 0.2s;
            color: #2d5c2f;
            border-bottom: 3px solid transparent;
            border-radius: 0 0 12px 12px;
            margin: 0 4px;
        }
        .nav-btn:focus,
        .nav-btn:active,
        .nav-btn:hover,
        .nav-btn.active {
            background: #baffba;
            color: #007a00;
            font-weight: bold;
            border-bottom: 3px solid #007a00;
            outline: none;
        }
        @media print {
            #custom-navbar, .btn, .mb-3, .form-check, .form-switch {
                display: none !important;
            }
            body, .container {
                background: #fff !important;
                color: #000 !important;
                box-shadow: none !important;
            }
            table {
                page-break-inside: avoid;
            }
            th, td {
                color: #000 !important;
                background: #fff !important;
                border-color: #333 !important;
            }
            input, select, textarea {
                border: none !important;
                background: transparent !important;
                color: #000 !important;
                box-shadow: none !important;
                outline: none !important;
                pointer-events: none !important;
                appearance: none !important;
                -webkit-appearance: none !important;
                font-size: inherit !important;
                padding: 0 !important;
                margin: 0 !important;
                width: auto !important;
                min-width: 0 !important;
                max-width: 100% !important;
                height: auto !important;
            }
            input[type="number"], input[type="text"] {
                text-align: left !important;
            }
            #dados-impressao { display: block !important; }
        }
        @page { size: A4 landscape; }
        .form-control.input-sm, .form-control.input-md, .form-control.input-lg, .form-control.input-xs {
            min-height: 28px;
            font-size: 0.92em;
            padding: 2px 6px;
        }
    </style>
</head>
<body>
    <div style="width:100%;display:flex;justify-content:flex-start;margin-top:4px;margin-bottom:12px; background: #fff;gap:0;flex-wrap:wrap;position:sticky;top:0;z-index:1001;box-shadow:0 2px 8px #0002;">
        <img src="logo-superendividamento.png" alt="SUPERENDIVIDAMENTO" style="max-width:20%; min-width:5%; height:70px; display:block; box-shadow: 0 2px 8px #0001; border-radius: 12px; margin-left:4px; margin-right:0;" />
        <div style="flex:1;justify-content:flex-start; width: 80%; padding-top: 5px; padding-bottom: 5px;">
            <div id="custom-navbar" style="height: 60px; position:static;box-shadow:none;margin-bottom:0;background:linear-gradient(90deg, #e0ffe0 0%, #baffba 100%);border-radius:16px;padding:6px 8px; margin-left:2; margin-right:4px;">
                <button onclick="window.location.href='index.html'" class="nav-btn" id="btn-dados">Dados Socioeconômicos</button>
                <button onclick="window.location.href='geral.html'" class="nav-btn" id="btn-geral">Geral</button>
                <button onclick="window.location.href='plano-de-pagamento.html'" class="nav-btn" id="btn-plano">Plano de Pagamento</button>
                <button onclick="window.location.href='panorama.html'" class="nav-btn" id="btn-panorama">Panorama</button>
            </div>
        </div>
    </div>
    <div class="container"; style="background: #ffffff00;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:30px;">
            <h1>Plano de Pagamento</h1>
            <div style="display:flex; gap:10px;">
                <button type="button" class="btn btn-success mb-3" style="background:#baffba; color:#2d5c2f; border:none; font-weight:bold;" onclick="window.print()">Imprimir</button>
                <button type="button" class="btn btn-warning mb-3" style="background:#baffba; color:#2d5c2f; border:none; font-weight:bold;" onclick="limparCampos()">Limpar</button>
            </div>
        </div>
        <div id="dados-impressao" style="display:none; margin-bottom: 18px;">
          <div style="font-size:1.15em; font-weight:bold;">Consumidor: <span id="impressao-nome-consumidor"></span></div>
          <div style="font-size:1.15em; font-weight:bold;">Processo n.º: <span id="impressao-numero-processo"></span></div>
        </div>
        <!-- Tabela de Parâmetros do Plano -->
        <form id="planoForm">
            <div class="row mb-4">
                <div class="col-lg-8">
                    <table class="table table-bordered mb-0">
                        <tr>
                            <th>Renda Comprometida</th>
                            <th>Margem</th>
                            <th>Qtde. de Parcelas</th>
                        </tr>
                        <tr>
                            <td style="position: relative;">
                                <input type="number" step="0.1" min="0" max="100" id="comprometida" class="form-control input-sm" value="30" style="padding-right: 20px;">
                                <span style="position: absolute; left: 40px; top: 50%; transform: translateY(-50%);">%</span>
                            </td>
                            <td><input type="text" id="margem" class="form-control input-md bg-light-green" readonly></td>
                            <td>
                                <input type="number" step="1" min="2" max="60" id="qtdeParcelas" class="form-control input-sm" value="2">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <div class="row" style="margin-top:8px;">
                                    <div class="col-md-6" style="display:flex; flex-direction:column; align-items:flex-start;">
                                        <label for="condicaoEspecial" style="font-weight:bold;">Condição especial de parcelamento? (Até 120x)</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="condicaoEspecial" style="width: 48px; height: 24px;">
                                        </div>
                                    </div>
                                    <div class="col-md-6" style="display:flex; flex-direction:column; align-items:flex-start;">
                                        <label for="taxaJurosMensalResidual" style="font-weight:bold;">Taxa de Juros Mensal da Parcela Residual (%)</label>
                                        <input type="number" step="0.01" min="0" max="100" id="taxaJurosMensalResidual" class="form-control input-sm" value="1" style="width: 100%; max-width: 220px;">
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-lg-4 d-flex align-items-center">
                    <div class="ms-3">
                        <label for="receitaTotal" class="form-label mb-0">Receita mensal após despesas (R$):</label>
                        <span id="receitaTotal" class="form-control input-md" style="background:#e9ecef;display:block;min-height:38px;"></span>
                    </div>
                </div>
            </div>
            <!-- Tabela de Distribuição das Dívidas -->
            <div class="row mb-4">
                <div class="col-12 scroll-x">
                    <table class="table table-bordered mb-0" id="tabela-dividas">
                        <thead class="table-light">
                            <tr>
                                <th>Credor</th>
                                <th>Informação</th>
                                <th>Valor total pago</th>
                                <th>% do saldo pago</th>
                                <th class="bg-medium-gray">Saldo Devedor</th>
                                <th>% Dívida</th>
                                <th class="bg-medium-gray">Valor da Parcela</th>
                                <th>Parcela Residual</th>
                            </tr>
                        </thead>
                        <tbody id="dividas-body">
                            <!-- Linhas geradas por JS -->
                        </tbody>
                        <tfoot>
                            <tr class="subtotal-row">
                                <td colspan="2">Total/Subtotal</td>
                                <td id="total-valor-pago">R$ 0,00</td>
                                <td></td>
                                <td id="total-saldo-devedor" class="bg-medium-gray">R$ 0,00</td>
                                <td id="total-pct-divida">100%</td>
                                <td id="total-valor-parcela" class="bg-medium-gray">R$ 0,00</td>
                                <td id="total-parcela-residual">R$ 0,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <!-- Tabela de Plano de Pagamento Proposto -->
            <div class="row mb-4">
                <div class="col-12 scroll-x">
                    <table class="table table-bordered mb-0" id="tabela-parcelas">
                        <thead class="table-light" id="parcelas-head">
                            <!-- Cabeçalho gerado por JS -->
                        </thead>
                        <tbody id="parcelas-body">
                            <!-- Linhas geradas por JS -->
                        </tbody>
                        <tfoot id="parcelas-foot">
                            <!-- Rodapé gerado por JS -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </form>
    </div>
    <script>
    const bancos = [
        'Itaú', 'Bradesco', 'BMG RMG', 'Agibank', 'Banco do Brasil', 'Santander', 'Mercantil do Brasil', 'Sicob'
    ];
    const infoPadrao = [
        'Dívida 1', 'Dívida 2', 'Dívida 3', 'Dívida 4', 'Dívida 5', 'Dívida 6', 'Dívida 7', 'Dívida 8'
    ];
    const numDividas = 8;

    function formatBRL(value) {
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function renderDividasTable() {
        const tbody = document.getElementById('dividas-body');
        tbody.innerHTML = '';
        let linhasPreenchidas = 0;

        // Recuperar dados dos consignados
        const linhasConsignados = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
        // Recuperar dados dos não consignados
        const linhasNaoConsignados = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
        // Recuperar dados sem parcelas
        const linhasSemParcelas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
        // Recuperar dívidas consolidadas
        const linhasDividasConsolidadas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');

        // Função para processar e exibir linhas de qualquer tabela dinâmica
        function processarLinhas(linhas) {
            linhas.forEach((linha) => {
                if ((linha.credor && linha.credor !== '') || (linha.saldoDevedor && linha.saldoDevedor !== '') || (linha.contratos && linha.contratos !== '')) {
                    linhasPreenchidas++;
                    const valorPago = parseFloat(linha.valorPago) || 0;
                    const saldoDevedor = parseFloat(linha.saldoDevedor) || 0;
                    const pctPago = saldoDevedor > 0 ? (valorPago / (valorPago + saldoDevedor) * 100).toFixed(2) : '0.00';
                    tbody.innerHTML += `
                        <tr>
                            <td>${linha.credor || ''}</td>
                            <td>${linha.contratos || ''}</td>
                            <td>${formatBRL(valorPago)}</td>
                            <td>${pctPago}%</td>
                            <td>${formatBRL(saldoDevedor)}</td>
                            <td class="pct-divida">0%</td>
                            <td class="valor-parcela">R$ 0,00</td>
                            <td class="parcela-residual">R$ 0,00</td>
                        </tr>
                    `;
                }
            });
        }

        processarLinhas(linhasConsignados);
        processarLinhas(linhasNaoConsignados);
        processarLinhas(linhasSemParcelas);
        processarLinhas(linhasDividasConsolidadas);

        atualizarTotais();
    }

    function atualizarTotais() {
        let totalValorPago = 0;
        let totalSaldoDevedor = 0;
        let totalParcelaResidual = 0;

        // Somar valores dos consignados
        const linhasConsignados = JSON.parse(localStorage.getItem('linhas-consignados') || '[]');
        linhasConsignados.forEach(linha => {
            totalValorPago += parseFloat(linha.valorPago) || 0;
            totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
        });
        // Somar valores dos não consignados
        const linhasNaoConsignados = JSON.parse(localStorage.getItem('linhas-nao-consignados') || '[]');
        linhasNaoConsignados.forEach(linha => {
            totalValorPago += parseFloat(linha.valorPago) || 0;
            totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
        });
        // Somar valores sem parcelas
        const linhasSemParcelas = JSON.parse(localStorage.getItem('linhas-sem-parcelas') || '[]');
        linhasSemParcelas.forEach(linha => {
            totalValorPago += parseFloat(linha.valorPago) || 0;
            totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
        });
        // Somar dívidas consolidadas
        const linhasDividasConsolidadas = JSON.parse(localStorage.getItem('linhas-dividas-consolidadas') || '[]');
        linhasDividasConsolidadas.forEach(linha => {
            totalValorPago += parseFloat(linha.valorPago) || 0;
            totalSaldoDevedor += parseFloat(linha.saldoDevedor) || 0;
        });

        document.getElementById('total-valor-pago').textContent = formatBRL(totalValorPago);
        document.getElementById('total-saldo-devedor').textContent = formatBRL(totalSaldoDevedor);

        // Atualizar percentuais e valores das parcelas
        const rows = document.querySelectorAll('#dividas-body tr');
        rows.forEach(row => {
            const saldoDevedorCell = row.cells[4];
            const saldoDevedor = parseFloat(saldoDevedorCell.textContent.replace(/[^\\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            const pctDivida = totalSaldoDevedor > 0 ? (saldoDevedor / totalSaldoDevedor * 100) : 0;
            row.querySelector('.pct-divida').textContent = pctDivida.toFixed(2) + '%';
        });

        calcularParcelas();
    }

    function atualizarReceitaTotal() {
        const valorFinal = parseFloat(localStorage.getItem('valor-final')) || 0;
        const elementoReceita = document.getElementById('receitaTotal');
        if (elementoReceita) {
            elementoReceita.textContent = valorFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
    }

    function calcularDividas() {
        const receitaTotal = parseFloat(localStorage.getItem('valor-final')) || 0;
        document.getElementById('receitaTotal').textContent = formatBRL(receitaTotal);

        const pctComprometida = parseFloat(document.getElementById('comprometida').value) || 0;
        const margem = receitaTotal * (pctComprometida / 100);
        document.getElementById('margem').value = formatBRL(margem);

        const qtdeParcelas = parseInt(document.getElementById('qtdeParcelas').value) || 0;
        const maxParcelas = document.getElementById('condicaoEspecial').checked ? 120 : 60;

        let alertMsg = '';
        if (qtdeParcelas > maxParcelas) {
            alertMsg = `ATENÇÃO: A quantidade de parcelas não pode ser maior que ${maxParcelas}!`;
            document.getElementById('qtdeParcelas').value = maxParcelas;
        }

        // Calcular saldo devedor total e valores pagos
        const rows = document.querySelectorAll('#dividas-body tr');
        let totalSaldoDevedor = 0;
        let totalValorPago = 0;
        let totalValorParcela = 0;
        let totalParcelaResidual = 0;

        rows.forEach(row => {
            const valorPago = parseFloat(row.cells[2].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            totalValorPago += valorPago;
            totalSaldoDevedor += saldoDevedor;
        });

        document.getElementById('total-valor-pago').textContent = formatBRL(totalValorPago);
        document.getElementById('total-saldo-devedor').textContent = formatBRL(totalSaldoDevedor);

        // Calcular valor total mensal das parcelas
        const valorParcelaTotal = qtdeParcelas > 0 ? totalSaldoDevedor / qtdeParcelas : 0;

        // Atualizar cada linha
        rows.forEach(row => {
            const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            const pctDivida = totalSaldoDevedor > 0 ? (saldoDevedor / totalSaldoDevedor * 100) : 0;
            const valorParcela = (pctDivida * valorParcelaTotal) / 100;
            
            // Atualizar percentual da dívida
            row.querySelector('.pct-divida').textContent = pctDivida.toFixed(2) + '%';
            
            // Atualizar valor da parcela
            const valorParcelaCell = row.querySelector('.valor-parcela');
            if (valorParcela > 0) {
                valorParcelaCell.textContent = `${qtdeParcelas}x de ${formatBRL(valorParcela)}`;
            } else {
                valorParcelaCell.textContent = 'R$ 0,00';
            }
            
            // Calcular e atualizar parcela residual
            let parcelaResidual = 0;
            const taxaJurosMensal = parseFloat(document.getElementById('taxaJurosMensalResidual').value) / 100 || 0; // Converte para decimal
            
            if (qtdeParcelas <= 60) { // Só calcula residual se estiver dentro do limite padrão
                if (taxaJurosMensal === 0) {
                    parcelaResidual = valorParcela;
                } else {
                    // Aplica os juros sobre o valor da parcela
                    parcelaResidual = valorParcela * (1 + taxaJurosMensal);
                }
            }
            
            row.querySelector('.parcela-residual').textContent = formatBRL(parcelaResidual);
            totalParcelaResidual += parcelaResidual;
            
            totalValorParcela += valorParcela;
        });

        // Atualizar totais
        document.getElementById('total-pct-divida').textContent = '100%';
        const totalValorParcelaFormatado = totalValorParcela > 0 ? `${qtdeParcelas}x de ${formatBRL(totalValorParcela)}` : 'R$ 0,00';
        document.getElementById('total-valor-parcela').textContent = totalValorParcelaFormatado;
        document.getElementById('total-parcela-residual').textContent = formatBRL(totalParcelaResidual);

        // Cálculo do valor mínimo de parcelas para caber na margem
        let minParcelas = 2;
        if (margem > 0) {
            minParcelas = Math.ceil(totalSaldoDevedor / margem);
            if (minParcelas < 2) minParcelas = 2;
            if (minParcelas > maxParcelas) minParcelas = maxParcelas;
        }

        // Se a quantidade de parcelas for menor que o mínimo, ajustar e alertar
        if (qtdeParcelas < minParcelas) {
            document.getElementById('qtdeParcelas').value = minParcelas;
            alertMsg = `O número de parcelas foi ajustado para ${minParcelas} para que a parcela mensal caiba na margem disponível.`;
            calcularDividas(); // Recalcular com o novo valor
            return;
        }

        // Se nem mesmo o máximo permitido for suficiente
        if ((totalSaldoDevedor / maxParcelas) > margem) {
            alertMsg = `Não é possível pagar o valor total das dívidas (${formatBRL(totalSaldoDevedor)}) com a margem disponível (${formatBRL(margem)}) mesmo em ${maxParcelas}x. Reduza o valor das dívidas ou aumente a margem.`;
        }

        // Renderizar a tabela de parcelas
        renderParcelasTable(qtdeParcelas, receitaTotal, pctComprometida, margem, totalSaldoDevedor, valorParcelaTotal);

        // Exibir alerta se necessário
        const alertaDiv = document.getElementById('alerta-margem') || (() => {
            const d = document.createElement('div');
            d.id = 'alerta-margem';
            d.style.margin = '16px 0';
            d.style.fontWeight = 'bold';
            d.style.color = '#d00';
            d.style.fontSize = '1.1em';
            document.querySelector('.container').insertBefore(d, document.querySelector('.container').children[1]);
            return d;
        })();
        alertaDiv.textContent = alertMsg;
        if (!alertMsg) alertaDiv.style.display = 'none'; else alertaDiv.style.display = '';
    }

    function renderParcelasTable(qtdeParcelas, receitaTotal, pctComprometida, margem, totalSaldoDevedor, valorParcelaTotal) {
        const head = document.getElementById('parcelas-head');
        const body = document.getElementById('parcelas-body');
        const foot = document.getElementById('parcelas-foot');
        head.innerHTML = '';
        body.innerHTML = '';
        foot.innerHTML = '';

        // Get all rows from the first table
        const rows = Array.from(document.querySelectorAll('#dividas-body tr'));
        if (rows.length === 0) return;

        // Build header
        let ths = '<tr><th>Mês</th>';
        rows.forEach(row => {
            const credor = row.cells[0].textContent.trim();
            if (credor) {
                ths += `<th>${credor}</th>`;
            }
        });
        ths += '<th>Total</th></tr>';
        head.innerHTML = ths;

        // Build body rows
        if (qtdeParcelas > 0 && totalSaldoDevedor > 0) {
            // Primeiro mês como exemplo para pegar o valor total mensal
            let tds = `<td>Mês 1</td>`;
            let somaLinha = 0;

            rows.forEach(row => {
                const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
                const pctDivida = totalSaldoDevedor > 0 ? saldoDevedor / totalSaldoDevedor : 0;
                const valorParcela = +(pctDivida * valorParcelaTotal).toFixed(2);
                tds += `<td>${formatBRL(valorParcela)}</td>`;
                somaLinha += valorParcela;
            });

            // Salvar o valor total mensal no localStorage (soma de todas as parcelas de um mês)
            somaLinha = +(somaLinha).toFixed(2);
            localStorage.setItem('plano-valor-total-parcela', somaLinha.toString());

            tds += `<td>${formatBRL(somaLinha)}</td>`;
            body.innerHTML += `<tr>${tds}</tr>`;

            // Gerar as linhas restantes
            for (let mes = 2; mes <= qtdeParcelas; mes++) {
                tds = `<td>Mês ${mes}</td>`;
                rows.forEach(row => {
                    const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
                    const pctDivida = totalSaldoDevedor > 0 ? saldoDevedor / totalSaldoDevedor : 0;
                    const valorParcela = +(pctDivida * valorParcelaTotal).toFixed(2);
                    tds += `<td>${formatBRL(valorParcela)}</td>`;
                });
                tds += `<td>${formatBRL(somaLinha)}</td>`;
                body.innerHTML += `<tr>${tds}</tr>`;
            }

            // Build footer (totals)
            let tfs = '<tr><td>Total</td>';
            let totalGeral = 0;

            rows.forEach(row => {
                const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
                const pctDivida = totalSaldoDevedor > 0 ? saldoDevedor / totalSaldoDevedor : 0;
                const totalColuna = +(pctDivida * valorParcelaTotal * qtdeParcelas).toFixed(2);
                tfs += `<td>${formatBRL(totalColuna)}</td>`;
                totalGeral += totalColuna;
            });

            totalGeral = +(totalGeral).toFixed(2);
            tfs += `<td>${formatBRL(totalGeral)}</td></tr>`;
            foot.innerHTML = tfs;
        } else {
            // Se não houver parcelas, zerar o valor no localStorage
            localStorage.setItem('plano-valor-total-parcela', '0');
        }
    }

    function calcularParcelas() {
        const qtdeParcelas = parseInt(document.getElementById('qtdeParcelas').value) || 0;
        const maxParcelas = document.getElementById('condicaoEspecial').checked ? 120 : 60;
        const rows = document.querySelectorAll('#dividas-body tr');
        let totalSaldoDevedor = 0;
        let totalValorParcela = 0;

        // Primeiro loop: calcular o total do saldo devedor
        rows.forEach(row => {
            const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            totalSaldoDevedor += saldoDevedor;
        });

        // Calcula o valor total mensal das parcelas
        const valorParcelaTotal = qtdeParcelas > 0 ? totalSaldoDevedor / qtdeParcelas : 0;

        // Segundo loop: atualizar cada linha
        rows.forEach(row => {
            const saldoDevedor = parseFloat(row.cells[4].textContent.replace(/[^\d,]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            const pctDivida = totalSaldoDevedor > 0 ? (saldoDevedor / totalSaldoDevedor * 100) : 0;
            const valorParcela = (pctDivida * valorParcelaTotal) / 100;
            
            totalValorParcela += valorParcela;
        });

        // Atualiza o total das parcelas
        const totalValorParcelaFormatado = totalValorParcela > 0 ? `${qtdeParcelas}x de ${formatBRL(totalValorParcela)}` : 'R$ 0,00';
        document.getElementById('total-valor-parcela').textContent = totalValorParcelaFormatado;
    }

    // Eventos
    renderDividasTable();
    calcularDividas();
    ['receitaTotal','comprometida','qtdeParcelas'].forEach(id => {
        document.getElementById(id).addEventListener('input', calcularDividas);
    });
    document.getElementById('dividas-body').addEventListener('input', calcularDividas);
    document.getElementById('dividas-body').addEventListener('change', calcularDividas);

    // Ativa o botão da página atual
    const page = window.location.pathname.split('/').pop();
    if(page.includes('dados-socioeconomicos')) document.getElementById('btn-dados').classList.add('active');
    if(page.includes('geral')) document.getElementById('btn-geral').classList.add('active');
    if(page.includes('plano-de-pagamento')) document.getElementById('btn-plano').classList.add('active');
    if(page.includes('panorama')) document.getElementById('btn-panorama').classList.add('active');

    document.addEventListener('DOMContentLoaded', function() {
        atualizarReceitaTotal();
        // Carregar dados salvos
        carregarDadosImpressao();
        renderDividasTable();
        
        // Event listeners para campos de entrada
        document.getElementById('comprometida').addEventListener('input', function() {
            if (parseFloat(this.value) > 100) {
                this.value = 100;
            }
            localStorage.setItem('plano-pct-limite', this.value);
            calcularDividas();
        });

        document.getElementById('qtdeParcelas').addEventListener('input', function() {
            localStorage.setItem('plano-qtde-parcelas', this.value);
            calcularDividas();
        });

        document.getElementById('condicaoEspecial').addEventListener('change', function() {
            localStorage.setItem('plano-condicao-especial', this.checked);
            if (this.checked) {
                document.getElementById('qtdeParcelas').max = 120;
            } else {
                document.getElementById('qtdeParcelas').max = 60;
                if (document.getElementById('qtdeParcelas').value > 60) {
                    document.getElementById('qtdeParcelas').value = 60;
                    localStorage.setItem('plano-qtde-parcelas', '60');
                }
            }
            calcularDividas();
        });

        // Carregar valores salvos
        const pctLimite = localStorage.getItem('plano-pct-limite');
        if (pctLimite) document.getElementById('comprometida').value = pctLimite;

        const qtdeParcelas = localStorage.getItem('plano-qtde-parcelas');
        if (qtdeParcelas) document.getElementById('qtdeParcelas').value = qtdeParcelas;

        const condicaoEspecial = localStorage.getItem('plano-condicao-especial');
        if (condicaoEspecial) {
            document.getElementById('condicaoEspecial').checked = condicaoEspecial === 'true';
            if (condicaoEspecial === 'true') {
                document.getElementById('qtdeParcelas').max = 120;
            }
        }

        // Configurar observadores para mudanças nas outras tabelas
        const observeInputChanges = (prefix, count) => {
            for (let i = 1; i <= count; i++) {
                ['credores', 'contratos', 'valor-contratado', 'valor-pago', 'saldo-devedor', 'juros', 'parcela-mensal', 'parcelas-contratadas', 'parcelas-restantes'].forEach(field => {
                    const input = document.getElementById(`${prefix}-${i}-${field}`);
                    if (input) {
                        input.addEventListener('input', function() {
                            localStorage.setItem(`${prefix}-${i}-${field}`, this.value);
                            renderDividasTable();
                        });
                    }
                });
            }
        };

        // Configurar observadores para cada tipo de dívida
        observeInputChanges('nao-consignado', 2);
        observeInputChanges('sem-parcela', 1);
        observeInputChanges('divida-consolidada', 2);

        // Forçar atualização dos cálculos
        calcularDividas();
    });

    // Atualizar quando o valor mudar em outra página
    window.addEventListener('storage', function(e) {
        if (e.key === 'valor-final') {
            atualizarReceitaTotal();
        }
        calcularDividas();
    });

    function limparCampos() {
        if (confirm('Tem certeza que deseja limpar todos os dados?')) {
            // Limpar dados dos consignados
            localStorage.removeItem('linhas-consignados');
            
            // Limpar dados dos não consignados
            for (let i = 1; i <= 2; i++) {
                ['credores', 'contratos', 'valor-contratado', 'valor-pago', 'saldo-devedor', 'juros', 'parcela-mensal', 'parcelas-contratadas', 'parcelas-restantes'].forEach(field => {
                    localStorage.removeItem(`nao-consignado-${i}-${field}`);
                });
            }
            
            // Limpar dados sem parcelas
            for (let i = 1; i <= 1; i++) {
                ['credores', 'contratos', 'valor-contratado', 'valor-pago', 'saldo-devedor', 'juros', 'parcela-mensal', 'parcelas-contratadas', 'parcelas-restantes'].forEach(field => {
                    localStorage.removeItem(`sem-parcela-${i}-${field}`);
                });
            }
            
            // Limpar dívidas consolidadas
            for (let i = 1; i <= 2; i++) {
                ['credores', 'contratos', 'valor-contratado', 'valor-pago', 'saldo-devedor', 'juros', 'parcela-mensal', 'parcelas-contratadas', 'parcelas-restantes'].forEach(field => {
                    localStorage.removeItem(`divida-consolidada-${i}-${field}`);
                });
            }
            
            // Limpar configurações do plano
            localStorage.removeItem('plano-pct-limite');
            localStorage.removeItem('plano-qtde-parcelas');
            localStorage.removeItem('plano-condicao-especial');
            
            // Recarregar a página
            location.reload();
        }
    }

    function carregarDadosImpressao() {
        const nomeConsumidor = localStorage.getItem('nome-consumidor') || '';
        const numeroProcesso = localStorage.getItem('numero-processo') || '';
        document.getElementById('impressao-nome-consumidor').textContent = nomeConsumidor;
        document.getElementById('impressao-numero-processo').textContent = numeroProcesso;
    }

    // Adicionar event listener para o novo campo de taxa de juros
    document.getElementById('taxaJurosMensalResidual').addEventListener('input', function() {
        if (parseFloat(this.value) > 100) {
            this.value = 100;
        }
        calcularDividas();
    });
    </script>
</body>
</html>