<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Pagamento - Superendividamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f4f4; }
        .container { max-width: 1400px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h1 { color: #2d5c2f; margin-bottom: 30px; }
        table { font-size: 0.98rem; }
        th, td { vertical-align: middle !important; }
        .table-bordered th, .table-bordered td { border: 1px solid #333 !important; }
        .total-row { font-weight: bold; background: #f0f0f0; }
        .subtotal-row { font-weight: bold; background: #e0e0e0; }
        .input-sm { max-width: 90px; }
        .input-xs { max-width: 60px; }
        .input-md { max-width: 120px; }
        .input-lg { max-width: 180px; }
        .bg-light-green { background: #eaffea; }
        .bg-light-blue { background: #eaf4ff; }
        .bg-light-yellow { background: #fffbe6; }
        .text-green { color: #007a00; }
        .text-blue { color: #0057b7; }
        .text-red { color: #d00; }
        .scroll-x { overflow-x: auto; }
        @media (max-width: 900px) {
            .row { flex-direction: column; }
            .container { padding: 10px; }
        }
        #custom-navbar { margin-bottom: 30px; }
        .nav-btn {
            flex:1;
            background:#90ff90;
            border:none;
            border-right:1px solid #fff;
            font-size:1.2em;
            padding:12px 0;
            cursor:pointer;
            transition: background 0.2s, font-weight 0.2s;
        }
        .nav-btn:last-child { border-right:none; }
        .nav-btn.active {
            background:#baffba;
            font-weight:bold;
            outline:2px solid #000;
        }
    </style>
</head>
<body>
<div id="custom-navbar" style="display:flex; border:2px solid #000; background:#90ff90;">
  <button onclick="window.location.href='dados-socioeconomicos.html'" class="nav-btn" id="btn-dados">Dados Socioeconômicos</button>
  <button onclick="window.location.href='geral.html'" class="nav-btn" id="btn-geral">Geral</button>
  <button onclick="window.location.href='plano-de-pagamento.html'" class="nav-btn" id="btn-plano">Plano de Pagamento</button>
  <button onclick="window.location.href='panorama.html'" class="nav-btn" id="btn-panorama">Panorama</button>
</div>
<div class="container">
    <h1>Plano de Pagamento</h1>
    <!-- Tabela de Parâmetros do Plano -->
    <form id="planoForm">
        <div class="row mb-4">
            <div class="col-lg-8">
                <table class="table table-bordered mb-0">
                    <tr>
                        <th>% Comprometida</th>
                        <th>Margem</th>
                        <th>Meses para quitar</th>
                        <th>Qtde. de Parcelas</th>
                    </tr>
                    <tr>
                        <td><input type="number" step="0.01" min="0" max="1" id="comprometida" class="form-control input-xs" value="0.3"></td>
                        <td><input type="text" id="margem" class="form-control input-md bg-light-green" readonly></td>
                        <td><input type="number" step="1" min="1" id="mesesQuitar" class="form-control input-xs" value="60"></td>
                        <td><input type="number" step="1" min="1" id="qtdeParcelas" class="form-control input-xs" value="60"></td>
                    </tr>
                </table>
            </div>
            <div class="col-lg-4 d-flex align-items-center">
                <div class="ms-3">
                    <label for="receitaTotal" class="form-label mb-0">Receita Total (R$):</label>
                    <input type="number" step="0.01" min="0" id="receitaTotal" class="form-control input-md" value="1412.00">
                </div>
            </div>
                    </div>
        <!-- Tabela de Distribuição das Dívidas -->
        <div class="row mb-4">
            <div class="col-12 scroll-x">
                <table class="table table-bordered mb-0" id="tabela-dividas">
                    <thead class="table-light">
                        <tr>
                            <th>Credor</th>
                            <th>Informação</th>
                            <th>Saldo Devedor</th>
                            <th>% Dívida</th>
                            <th>Valor da Parcela</th>
                            <th>Parcela Residual</th>
                            <th>Valor total pago</th>
                            <th>% do saldo pago</th>
                        </tr>
                    </thead>
                    <tbody id="dividas-body">
                        <!-- Linhas geradas por JS -->
                    </tbody>
                    <tfoot>
                        <tr class="subtotal-row">
                            <td colspan="2">Total/Subtotal</td>
                            <td id="total-saldo-devedor">R$ 0,00</td>
                            <td id="total-pct-divida">100%</td>
                            <td id="total-valor-parcela">R$ 0,00</td>
                            <td></td>
                            <td id="total-valor-pago">R$ 0,00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                    </div>
                </div>
        <!-- Tabela de Plano de Pagamento Proposto -->
        <div class="row mb-4">
            <div class="col-12 scroll-x">
                <table class="table table-bordered mb-0" id="tabela-parcelas">
                    <thead class="table-light" id="parcelas-head">
                        <!-- Cabeçalho gerado por JS -->
                    </thead>
                    <tbody id="parcelas-body">
                        <!-- Linhas geradas por JS -->
                    </tbody>
                    <tfoot id="parcelas-foot">
                        <!-- Rodapé gerado por JS -->
                    </tfoot>
                </table>
            </div>
        </div>
    </form>
    </div>
<script>
const bancos = [
    'Itaú', 'Bradesco', 'BMG RMG', 'Agibank', 'Banco do Brasil', 'Santander', 'Mercantil do Brasil', 'Sicob'
];
const infoPadrao = [
    'Dívida 1', 'Dívida 2', 'Dívida 3', 'Dívida 4', 'Dívida 5', 'Dívida 6', 'Dívida 7', 'Dívida 8'
];
const numDividas = 8;

function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function renderDividasTable() {
    const tbody = document.getElementById('dividas-body');
    tbody.innerHTML = '';
    for (let i = 0; i < numDividas; i++) {
        tbody.innerHTML += `
        <tr>
            <td><select class="form-select credor-select">${bancos.map(b=>`<option value="${b}">${b}</option>`).join('')}</select></td>
            <td><input type="text" class="form-control info-input" value="${infoPadrao[i]}"></td>
            <td><input type="number" step="0.01" min="0" class="form-control saldo-input" value="0"></td>
            <td class="pct-divida">0%</td>
            <td class="valor-parcela">R$ 0,00</td>
            <td class="parcela-residual">R$ 0,00</td>
            <td class="valor-pago">R$ 0,00</td>
            <td class="pct-saldo-pago">-</td>
        </tr>`;
    }
}

function calcularDividas() {
    const receitaTotal = parseFloat(document.getElementById('receitaTotal').value) || 0;
    const pctComprometida = parseFloat(document.getElementById('comprometida').value) || 0;
    const margem = receitaTotal * pctComprometida;
    document.getElementById('margem').value = formatBRL(margem);
    const mesesQuitar = parseInt(document.getElementById('mesesQuitar').value) || 60;
    const qtdeParcelas = parseInt(document.getElementById('qtdeParcelas').value) || 60;

    // Saldo devedor
    let totalSaldoDevedor = 0;
    const saldoInputs = document.querySelectorAll('.saldo-input');
    saldoInputs.forEach(input => {
        totalSaldoDevedor += parseFloat(input.value) || 0;
    });
    document.getElementById('total-saldo-devedor').textContent = formatBRL(totalSaldoDevedor);

    // % Dívida, Valor da Parcela, Parcela Residual, Valor total pago, % do saldo pago
    let totalValorParcela = 0;
    let totalValorPago = 0;
    saldoInputs.forEach((input, i) => {
        const saldo = parseFloat(input.value) || 0;
        const pctDivida = totalSaldoDevedor > 0 ? saldo / totalSaldoDevedor : 0;
        const valorParcela = pctDivida * margem;
        // Parcela Residual
        let parcelaResidual = 0;
        if (qtdeParcelas <= 60) {
            parcelaResidual = (mesesQuitar - qtdeParcelas) * valorParcela;
        }
        // Valor total pago
        let valorPago = 0;
        if (qtdeParcelas > 60) {
            valorPago = valorParcela * 60;
        } else {
            valorPago = qtdeParcelas * valorParcela + parcelaResidual;
        }
        // % do saldo pago
        let pctSaldoPago = saldo > 0 ? valorPago / saldo : '-';
        // Atualiza células
        document.querySelectorAll('.pct-divida')[i].textContent = (pctDivida*100).toFixed(2) + '%';
        document.querySelectorAll('.valor-parcela')[i].textContent = formatBRL(valorParcela);
        document.querySelectorAll('.parcela-residual')[i].textContent = formatBRL(parcelaResidual);
        document.querySelectorAll('.valor-pago')[i].textContent = formatBRL(valorPago);
        document.querySelectorAll('.pct-saldo-pago')[i].textContent = pctSaldoPago === '-' ? '-' : (pctSaldoPago*100).toFixed(2) + '%';
        totalValorParcela += valorParcela;
        totalValorPago += valorPago;
    });
    document.getElementById('total-pct-divida').textContent = '100%';
    document.getElementById('total-valor-parcela').textContent = formatBRL(totalValorParcela);
    document.getElementById('total-valor-pago').textContent = formatBRL(totalValorPago);

    renderParcelasTable(qtdeParcelas);
}

function renderParcelasTable(qtdeParcelas) {
    // Cabeçalho
    const head = document.getElementById('parcelas-head');
    const body = document.getElementById('parcelas-body');
    const foot = document.getElementById('parcelas-foot');
    head.innerHTML = '';
    body.innerHTML = '';
    foot.innerHTML = '';
    // Bancos selecionados
    const bancosSelecionados = Array.from(document.querySelectorAll('.credor-select')).map(sel => sel.value);
    // Remove duplicados mantendo ordem
    const bancosUnicos = bancosSelecionados.filter((b, i, arr) => arr.indexOf(b) === i);
    // Cabeçalho
    let ths = '<th>Mês</th>';
    bancosUnicos.forEach(banco => ths += `<th>${banco}</th>`);
    ths += '<th>Total</th>';
    head.innerHTML = `<tr>${ths}</tr>`;
    // Linhas
    for (let mes = 1; mes <= qtdeParcelas; mes++) {
        let tds = `<td>Mês ${mes}</td>`;
        let somaLinha = 0;
        bancosUnicos.forEach((banco, idx) => {
            // Soma valor da parcela para cada banco
            let valor = 0;
            document.querySelectorAll('.credor-select').forEach((sel, i) => {
                if (sel.value === banco) {
                    const saldo = parseFloat(document.querySelectorAll('.saldo-input')[i].value) || 0;
                    const totalSaldoDevedor = parseFloat(document.getElementById('total-saldo-devedor').textContent.replace(/[^\d,\.]/g, '').replace(',', '.')) || 0;
                    const receitaTotal = parseFloat(document.getElementById('receitaTotal').value) || 0;
                    const pctComprometida = parseFloat(document.getElementById('comprometida').value) || 0;
                    const margem = receitaTotal * pctComprometida;
                    const pctDivida = totalSaldoDevedor > 0 ? saldo / totalSaldoDevedor : 0;
                    valor += pctDivida * margem;
                }
            });
            tds += `<td>${formatBRL(valor)}</td>`;
            somaLinha += valor;
        });
        tds += `<td>${formatBRL(somaLinha)}</td>`;
        body.innerHTML += `<tr>${tds}</tr>`;
    }
    // Rodapé (total por banco)
    let tfs = '<td>Total</td>';
    bancosUnicos.forEach((banco, idx) => {
        let somaCol = 0;
        for (let mes = 1; mes <= qtdeParcelas; mes++) {
            document.querySelectorAll('.credor-select').forEach((sel, i) => {
                if (sel.value === banco) {
                    const saldo = parseFloat(document.querySelectorAll('.saldo-input')[i].value) || 0;
                    const totalSaldoDevedor = parseFloat(document.getElementById('total-saldo-devedor').textContent.replace(/[^\d,\.]/g, '').replace(',', '.')) || 0;
                    const receitaTotal = parseFloat(document.getElementById('receitaTotal').value) || 0;
                    const pctComprometida = parseFloat(document.getElementById('comprometida').value) || 0;
                    const margem = receitaTotal * pctComprometida;
                    const pctDivida = totalSaldoDevedor > 0 ? saldo / totalSaldoDevedor : 0;
                    somaCol += pctDivida * margem;
                }
            });
        }
        tfs += `<td>${formatBRL(somaCol)}</td>`;
    });
    // Total geral
    let totalGeral = 0;
    bancosUnicos.forEach((banco, idx) => {
        for (let mes = 1; mes <= qtdeParcelas; mes++) {
            document.querySelectorAll('.credor-select').forEach((sel, i) => {
                if (sel.value === banco) {
                    const saldo = parseFloat(document.querySelectorAll('.saldo-input')[i].value) || 0;
                    const totalSaldoDevedor = parseFloat(document.getElementById('total-saldo-devedor').textContent.replace(/[^\d,\.]/g, '').replace(',', '.')) || 0;
                    const receitaTotal = parseFloat(document.getElementById('receitaTotal').value) || 0;
                    const pctComprometida = parseFloat(document.getElementById('comprometida').value) || 0;
                    const margem = receitaTotal * pctComprometida;
                    const pctDivida = totalSaldoDevedor > 0 ? saldo / totalSaldoDevedor : 0;
                    totalGeral += pctDivida * margem;
                }
            });
        }
    });
    tfs += `<td>${formatBRL(totalGeral)}</td>`;
    foot.innerHTML = `<tr>${tfs}</tr>`;
}

// Eventos
renderDividasTable();
calcularDividas();
['receitaTotal','comprometida','mesesQuitar','qtdeParcelas'].forEach(id => {
    document.getElementById(id).addEventListener('input', calcularDividas);
});
document.getElementById('dividas-body').addEventListener('input', calcularDividas);
document.getElementById('dividas-body').addEventListener('change', calcularDividas);

// Ativa o botão da página atual
const page = window.location.pathname.split('/').pop();
if(page.includes('dados-socioeconomicos')) document.getElementById('btn-dados').classList.add('active');
if(page.includes('geral')) document.getElementById('btn-geral').classList.add('active');
if(page.includes('plano')) document.getElementById('btn-plano').classList.add('active');
if(page.includes('panorama')) document.getElementById('btn-panorama').classList.add('active');

document.getElementById('comprometida').addEventListener('input', function() {
    localStorage.setItem('plano-pct-limite', this.value);
});

window.onload = function() {
  document.querySelectorAll('input').forEach(function(input) {
    if (input.id && localStorage.getItem(input.id)) {
      input.value = localStorage.getItem(input.id);
    }
    input.oninput = function() {
      if (input.id) localStorage.setItem(input.id, this.value);
    };
  });
  // Ativa o botão da página atual
  const page = window.location.pathname.split('/').pop();
  if(page.includes('dados-socioeconomicos')) document.getElementById('btn-dados').classList.add('active');
  if(page.includes('geral')) document.getElementById('btn-geral').classList.add('active');
  if(page.includes('plano')) document.getElementById('btn-plano').classList.add('active');
  if(page.includes('panorama')) document.getElementById('btn-panorama').classList.add('active');
};
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 